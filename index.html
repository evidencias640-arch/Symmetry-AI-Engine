<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SYMMETRY AI ENGINE PRO — Improved</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#0f1724;--muted:#9aa4b2;--accent:#4ee1a1;--danger:#ff6b6b;--glass:rgba(255,255,255,0.04);
      --surface:#0b1220;--glass-2:rgba(255,255,255,0.03);
      --radius:14px;--gap:14px;--transition:.25s;
      font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,#07101b 0%, #06121a 100%);color:#e6eef7}
    .app{display:flex;gap:var(--gap);min-height:100vh;padding:18px;box-sizing:border-box}

    /* Layout */
    nav.sidebar{width:88px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:16px;padding:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    nav.sidebar .logo{height:48px;width:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#2ad6a3);display:flex;align-items:center;justify-content:center;font-weight:700}

    main.workspace{flex:1;display:grid;grid-template-columns:1fr 360px;gap:var(--gap)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px)}

    /* Left: Live view */
    #live-scan-view{display:flex;flex-direction:column;gap:12px}
    .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:var(--surface);min-height:420px;display:flex;align-items:center;justify-content:center}
    video#inputVideo{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:block}
    canvas#overlayCanvas{position:absolute;left:0;top:0;pointer-events:none}

    /* HUD */
    .hud{position:absolute;left:12px;top:12px;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(255,255,255,0.02));padding:10px;border-radius:10px;font-size:13px;color:var(--muted)}
    .hud strong{color:#fff}

    /* Controls */
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent), #2ad6a3);border:none;padding:8px 12px;border-radius:10px;color:#062222;font-weight:600;cursor:pointer;transition:transform var(--transition)}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn:active{transform:translateY(1px)}

    /* Right: Metrics */
    .metrics{display:flex;flex-direction:column;gap:12px}
    .metric-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--glass-2);font-size:14px}
    .metric-value{font-weight:700;color:#fff}

    /* Responsivity */
    @media (max-width:1000px){
      main.workspace{grid-template-columns:1fr}
      nav.sidebar{display:flex;flex-direction:row;gap:8px;height:auto;width:100%;padding:8px}
      .app{flex-direction:column;padding:12px}
      .video-wrap{min-height:360px}
    }

    /* subtle animations */
    .pulse{animation:pulse 2.2s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.01)}100%{transform:scale(1)}}

    /* Consent modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));z-index:60}
    .modal .box{width:min(760px,92%);padding:20px;border-radius:14px;background:linear-gradient(180deg,#07101a,#061224);box-shadow:0 20px 80px rgba(0,0,0,0.7)}
    .small{font-size:13px;color:var(--muted)}

    /* fancy loader */
    .loader{height:6px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));overflow:hidden}
    .loader > i{display:block;height:100%;width:30%;background:linear-gradient(90deg,var(--accent), #2ad6a3);transform:translateX(-110%);animation:slide 1.5s infinite}
    @keyframes slide{to{transform:translateX(110%)}}
  </style>
</head>
<body>
  <div class="app">
    <nav class="sidebar card">
      <div class="logo">SY</div>
      <div style="margin-top:14px;display:flex;flex-direction:column;gap:8px">
        <button class="btn secondary" id="btnStart">Iniciar</button>
        <button class="btn secondary" id="btnStop">Detener</button>
      </div>
      <div style="margin-top:auto;font-size:12px;color:var(--muted)">v13.4 • Demo</div>
    </nav>

    <main class="workspace">
      <section id="live-scan-view" class="card">
        <div class="video-wrap" id="videoWrap">
          <video id="inputVideo" autoplay muted playsinline></video>
          <canvas id="overlayCanvas"></canvas>
          <div class="hud" id="hudLive">
            <div>Estado: <strong id="statusText">Inactivo</strong></div>
            <div class="small">FPS <span id="fps">0</span> • Latencia <span id="lat">0</span>ms</div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div class="controls">
            <button class="btn" id="captureBtn">Capturar</button>
            <button class="btn secondary" id="exportBtn">Exportar</button>
          </div>
          <div style="width:240px">
            <div class="small">Carga modelos</div>
            <div class="loader" aria-hidden><i id="modelsLoader"></i></div>
          </div>
        </div>
      </section>

      <aside class="metrics card">
        <div class="metric-item"><div>ISF (Simetría)</div><div class="metric-value" id="isfVal">--</div></div>
        <div class="metric-item"><div>IPB (Proporción)</div><div class="metric-value" id="ipbVal">--</div></div>
        <div class="metric-item"><div>Edad</div><div class="metric-value" id="ageVal">--</div></div>
        <div class="metric-item"><div>Género</div><div class="metric-value" id="genderVal">--</div></div>
        <div class="metric-item"><div>Emoción</div><div class="metric-value" id="emotionVal">--</div></div>
        <div class="metric-item"><div>Confianza</div><div class="metric-value" id="confVal">--</div></div>
      </aside>
    </main>
  </div>

  <!-- Consent Modal -->
  <div id="consentModal" class="modal">
    <div class="box">
      <h3>Consentimiento para captura facial</h3>
      <p class="small">Este demo procesa imágenes faciales localmente en tu navegador para calcular métricas de simetría y generar un reporte. No enviamos imágenes a servidores externos. Al continuar autorizas el uso de tu cámara para esta sesión.</p>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:flex-end">
        <button id="decline" class="btn secondary">Cancelar</button>
        <button id="accept" class="btn">Aceptar y continuar</button>
      </div>
    </div>
  </div>

  <!-- Dependencies: face-api must be provided in ./libs/ or adjust path -->
  <script src="./libs/face-api.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    /* ======== Config & Helpers ======== */
    const MODELS_URL = './models';
    const video = document.getElementById('inputVideo');
    const canvas = document.getElementById('overlayCanvas');
    const ctx = canvas.getContext('2d');

    const hudStatus = document.getElementById('statusText');
    const fpsEl = document.getElementById('fps');
    const latEl = document.getElementById('lat');

    const isfEl = document.getElementById('isfVal');
    const ipbEl = document.getElementById('ipbVal');
    const ageEl = document.getElementById('ageVal');
    const genderEl = document.getElementById('genderVal');
    const emotionEl = document.getElementById('emotionVal');
    const confEl = document.getElementById('confVal');

    let modelsLoaded = false;
    let streaming = false;
    let detectInterval = null; // interval for detection
    let lastTs = performance.now();
    let frameCount = 0;

    function $(id){return document.getElementById(id)}

    function log(...args){console.log('[SY]',...args)}

    function average(arr){ if(!arr||arr.length===0) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }

    function centroid(points){
      if(!points || points.length===0) return {x:0,y:0};
      const sum = points.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});
      return { x: sum.x / points.length, y: sum.y / points.length };
    }

    /* normalize result coordinates to canvas/display size */
    function ensureCanvasSize(){
      const rect = video.getBoundingClientRect();
      canvas.width = Math.round(rect.width);
      canvas.height = Math.round(rect.height);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    }

    async function loadModels(){
      try{
        // prefer tiny detector for realtime speed, full models available if needed
        const loader = [
          faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL),
          faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODELS_URL),
          faceapi.nets.ageGenderNet.loadFromUri(MODELS_URL),
          faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL)
        ];
        await Promise.all(loader);
        modelsLoaded = true;
        document.getElementById('modelsLoader').style.opacity = 0;
        hudStatus.textContent = 'Modelos cargados';
        $('btnStart').disabled = false;
        log('Modelos cargados');
      }catch(err){
        hudStatus.textContent = 'Error cargando modelos';
        console.error('Error al cargar los modelos', err);
        alert('No se pudieron cargar los modelos. Verifica la ruta ./models');
      }
    }

    /* ===== Camera control ===== */
    async function startCamera(){
      if(!modelsLoaded){ alert('Espera a que carguen los modelos.'); return; }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}}, audio:false});
        video.srcObject = stream;
        await video.play();
        ensureCanvasSize();
        streaming = true;
        hudStatus.textContent = 'En vivo';
        startDetectionLoop();
      }catch(err){
        console.error('No existe camara o permiso denegado',err);
        hudStatus.textContent = 'Permiso denegado';
        alert('No se pudo acceder a la cámara. Verifica permisos.');
      }
    }

    function stopCamera(){
      streaming = false;
      hudStatus.textContent = 'Detenido';
      if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject = null; }
      clearInterval(detectInterval); detectInterval = null;
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    /* ===== Detection & Drawing ===== */
    function tinyOptions(){ return new faceapi.TinyFaceDetectorOptions({inputSize:256, scoreThreshold:0.45}); }

    async function startDetectionLoop(){
      if(detectInterval) clearInterval(detectInterval);
      let last = performance.now();
      detectInterval = setInterval(async ()=>{
        if(!streaming) return;
        const t0 = performance.now();
        const detection = await faceapi.detectSingleFace(video, tinyOptions()).withFaceLandmarks(true).withFaceExpressions();
        const t1 = performance.now();
        const latency = Math.round(t1-t0);
        latEl.textContent = latency;

        // FPS calculation
        frameCount++; if(performance.now()-lastTs>1000){ fpsEl.textContent = frameCount; frameCount=0; lastTs = performance.now(); }

        ensureCanvasSize();
        ctx.clearRect(0,0,canvas.width,canvas.height);

        if(detection && detection.landmarks){
          const displaySize = { width: canvas.width, height: canvas.height };
          const resized = faceapi.resizeResults(detection, displaySize);

          // draw bounding box
          const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4ee1a1';
          ctx.lineWidth = 2;
          ctx.strokeStyle = accent;
          ctx.beginPath();
          const box = resized.detection.box;
          ctx.rect(box.x, box.y, box.width, box.height);
          ctx.stroke();

          // landmarks
          ctx.fillStyle = 'rgba(255,255,255,0.85)';
          const points = resized.landmarks.positions;
          for(let p of points){ ctx.beginPath(); ctx.arc(p.x,p.y,1.2,0,Math.PI*2); ctx.fill(); }

          // compute metrics using normalized coords
          const leftCheek = resized.landmarks.getLeftEye();
          const rightCheek = resized.landmarks.getRightEye();
          const nose = centroid(resized.landmarks.getNose());
          const mouth = centroid(resized.landmarks.getMouth());

          // ISF: simplistic symmetry score (0-100)
          const dx = Math.abs(mouth.x - nose.x);
          const norm = Math.max(1, box.width);
          const isfScore = Math.max(0, 100 - (dx / norm) * 250); // tuned constant to give good spread

          // IPB: ratio between eye centers distance and mouth-nose distance
          const eyeCenter = { x: (centroid(leftCheek).x + centroid(rightCheek).x)/2, y: (centroid(leftCheek).y + centroid(rightCheek).y)/2 };
          const distEyes = Math.hypot(centroid(leftCheek).x - centroid(rightCheek).x, centroid(leftCheek).y - centroid(rightCheek).y);
          const distMouthNose = Math.hypot(mouth.x - nose.x, mouth.y - nose.y) || 1;
          const ipbScore = Math.max(0, Math.min(200, (distEyes / distMouthNose) * 10));

          // expressions - pick dominant
          const expressions = resized.expressions; let dominant = 'neutral'; let conf = 0;
          for(const k in expressions){ if(expressions[k] > conf){ conf = expressions[k]; dominant = k; }}

          // age & gender not available in streaming tiny landmarks step — request separately on capture
          isfEl.textContent = Math.round(isfScore) + ' / 100';
          ipbEl.textContent = Math.round(ipbScore*10)/10;
          emotionEl.textContent = dominant;
          confEl.textContent = Math.round(conf*100) + '%';

        } else {
          // no face
          isfEl.textContent = '--'; ipbEl.textContent = '--'; emotionEl.textContent = '--'; confEl.textContent = '--';
        }

      }, 150); // detect every 150ms (configurable)
    }

    /* ===== Capture & Export ===== */
    async function captureSnapshot(){
      if(!streaming){ alert('La cámara no está activa.'); return; }
      // draw current frame to an offscreen canvas and run heavier models
      const off = document.createElement('canvas'); off.width = video.videoWidth; off.height = video.videoHeight;
      const offCtx = off.getContext('2d'); offCtx.drawImage(video, 0, 0, off.width, off.height);

      hudStatus.textContent = 'Analizando captura...';
      // run full landmarks + age/gender
      const det = await faceapi.detectSingleFace(off, new faceapi.TinyFaceDetectorOptions({inputSize:512, scoreThreshold:0.4})).withFaceLandmarks(true).withAgeAndGender().withFaceExpressions();
      if(!det){ alert('No se detectó rostro en la captura. Intenta mover la cámara o ajustar iluminación.'); hudStatus.textContent='En vivo'; return; }

      // compute and show
      const display = { width: canvas.width, height: canvas.height };
      const resized = faceapi.resizeResults(det, display);
      const nose = centroid(resized.landmarks.getNose());
      const mouth = centroid(resized.landmarks.getMouth());
      const box = resized.detection.box;

      const dx = Math.abs(mouth.x - nose.x);
      const norm = Math.max(1, box.width);
      const isfScore = Math.max(0, 100 - (dx / norm) * 250);
      isfEl.textContent = Math.round(isfScore) + ' / 100';

      ageEl.textContent = det.age ? Math.round(det.age) : '--';
      genderEl.textContent = det.gender || '--';

      // draw final overlay
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4ee1a1';
      ctx.lineWidth = 2; ctx.strokeRect(box.x, box.y, box.width, box.height);
      hudStatus.textContent = 'Captura lista';
    }

    async function exportReport(){
      const wrap = document.querySelector('.app');
      hudStatus.textContent = 'Generando reporte...';
      const blob = await html2canvas(wrap, { scale: 1.4 }).then(c=> new Promise(r=> c.toBlob(r,'image/png')));
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'symmetry-report.png'; a.click();
      hudStatus.textContent = 'Reporte descargado';
    }

    /* ===== UI wiring ===== */
    document.getElementById('btnStart').addEventListener('click', ()=>{ if(!modelsLoaded){ alert('Esperando modelos.'); return;} startCamera(); });
    document.getElementById('btnStop').addEventListener('click', ()=>stopCamera());
    document.getElementById('captureBtn').addEventListener('click', ()=>captureSnapshot());
    document.getElementById('exportBtn').addEventListener('click', ()=>exportReport());

    // consent modal
    document.getElementById('accept').addEventListener('click', ()=>{ document.getElementById('consentModal').style.display = 'none'; loadModels(); });
    document.getElementById('decline').addEventListener('click', ()=>{ document.getElementById('consentModal').style.display = 'none'; hudStatus.textContent='Permiso no otorgado'; });

    // resize handling
    window.addEventListener('resize', ()=>{ if(streaming) ensureCanvasSize(); });

    // initial state
    $('btnStart').disabled = true; hudStatus.textContent = 'Cargando modelos...';

    // Kick off models load only after user accepts consent — handled in modal accept
  </script>
</body>
</html>
