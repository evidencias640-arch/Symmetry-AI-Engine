<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SYMMETRY AI ENGINE PRO V11.0 ‚Äî Live Scan Core</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /*
  =======================================================
  ESTILOS BASE Y VARIABLES (V11.0 - Profesional Grid/Flex)
  =======================================================
  */
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@300;600&display=swap');
  :root{
    --ia:#00ffff;
    --ia-light:#66ffff;
    --ia-glow: 0 0 15px var(--ia), 0 0 30px rgba(0,255,255,0.7);
    --bg:#000b11; /* Dark Mode base */
    --panel-bg: rgba(5, 15, 25, 0.9); /* Azul oscuro semi-transparente */
    --muted:#a0a9b5;
    --accent-error:#ff5050;
    --accent-warning:#ffaa00;
    --accent-success:#00ffb3;
    --shadow-light: 0 0 8px var(--ia), 0 0 12px var(--ia-light);
    --nav-width: 80px; /* Ancho de la barra lateral */
    --panel-width: 300px; /* Ancho del panel de m√©tricas */
  }

  /*
  ** 1. ESTRUCTURA DE P√ÅGINA (Grid y Dark Mode) **
  */
  body,html{
    margin:0;padding:0;width:100%;height:100%;background:var(--bg);
    color:#e6f9ff;font-family:Inter,Arial,sans-serif;
    overflow:hidden; 
    height: 100dvh; 
  }
  #main{
    position:relative;
    display: flex; /* Usamos flexbox para el layout principal en escritorio */
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  
  /*
  ** 2. BARRA DE NAVEGACI√ìN LATERAL (Simulada) **
  */
  #nav-sidebar {
    width: var(--nav-width);
    background: #011523; /* Azul muy oscuro */
    box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 20px;
    z-index: 50;
    flex-shrink: 0;
  }
  .nav-item {
    padding: 15px 0;
    width: 100%;
    text-align: center;
    cursor: pointer;
    font-size: 10px;
    transition: background 0.3s, color 0.3s;
    color: var(--muted);
  }
  .nav-item:hover, .nav-item.active {
    background: #022038;
    color: var(--ia-light);
    border-left: 3px solid var(--ia);
    box-shadow: 0 0 5px rgba(0,255,255,0.5);
  }
  .nav-item i { font-size: 20px; display: block; margin-bottom: 3px; }

  /*
  ** 3. CONTENEDOR CENTRAL DE ESCANEO **
  */
  #scan-container {
    flex-grow: 1; /* Ocupa todo el espacio restante */
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  
  /* C√ÅMARA y CANVAS */
  #webcam-feed{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;
    z-index: 1;
    transform: scaleX(-1); /* Efecto espejo */
    filter: brightness(0.7) contrast(1.2); /* Estilo de escaneo */
  }
  #capture-canvas{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;
    z-index: 5; 
    box-shadow: 0 0 20px rgba(0,255,255,0.5) inset;
    border: 2px solid rgba(0,255,255,0.4);
    transition: box-shadow 0.5s;
  }
  #placeholder{
    position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.95);z-index: 10; 
    text-align:center;
  }

  /* FEEDBACK DE POSICIONAMIENTO */
  #position-feedback {
      position: absolute;
      top: 10%; 
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 15px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 5px;
      color: var(--ia);
      font-weight: 600;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.5s, transform 0.5s;
      font-size: 14px;
      text-shadow: 0 0 5px var(--ia);
  }
  
  /* ANIMACI√ìN DE ESCANEO */
  .scanning-text {
      position: absolute;
      top: 5px;
      right: 5px;
      font-family: Orbitron, sans-serif;
      color: var(--ia-light);
      font-size: 16px;
      font-weight: 800;
      z-index: 15;
      animation: pulse-scan 1.5s infinite alternate;
  }
  @keyframes pulse-scan {
    from { opacity: 0.7; transform: scale(1); }
    to { opacity: 1; transform: scale(1.05); text-shadow: var(--ia-glow); }
  }


  /*
  ** 4. PANEL DE M√âTRICAS (Derecha) **
  */
  #metrics-panel{
    width: var(--panel-width);
    min-width: 250px;
    background: var(--panel-bg); 
    padding: 20px;
    backdrop-filter: blur(10px);
    box-shadow: -3px 0 15px rgba(0,0,0,0.5);
    overflow-y: auto;
    z-index: 50;
    flex-shrink: 0;
  }
  .metric-block { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed rgba(0,255,255,0.1); }
  .metric-label{
    font-family: Inter, Arial;
    font-weight: 600;
    color: var(--muted);
    font-size: 0.9em;
    margin-bottom: 5px;
  }
  .score-val{
    font-family:Orbitron, sans-serif;font-size:32px;font-weight:800;
    line-height: 1.1;
    color: var(--ia-light);
    text-shadow: var(--ia-glow);
  }
  #report-details .detail-line { font-size: 14px; margin-bottom: 5px; }

  /* BOT√ìN DE ACCI√ìN CENTRAL */
  #action-button-container {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 25;
      width: 90%; 
      max-width: 300px;
  }
  .btn{
    width: 100%;
    background:rgba(0,0,0,0.8);
    border:2px solid rgba(0,255,255,0.4);
    color:var(--ia);
    padding: 15px;
    border-radius:12px;
    cursor:pointer;
    backdrop-filter:blur(10px);
    font-weight:800;
    font-family: Orbitron, Arial;
    letter-spacing: 1px;
    font-size: 16px; 
    transition: background .3s, transform .2s, box-shadow .3s, opacity 0.3s;
  }
  .primary{
    background:linear-gradient(90deg,var(--ia),var(--ia-light));
    color:#000;
    border-color: var(--ia-light);
    box-shadow: var(--ia-glow);
  }
  .btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed; 
    box-shadow: none;
    background: rgba(10, 20, 30, 0.8);
    color: var(--muted);
    border-color: var(--muted);
  }

  /* ALERTA CR√çTICA MEJORADA (Animal/Objeto) */
  #critical-warning {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 60;
    padding: 20px;
    background: var(--accent-error);
    color: #000;
    font-weight: 900;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 30px var(--accent-error);
    width: 90%;
    max-width: 400px;
    font-size: 1.2em;
    font-family: Orbitron, sans-serif;
  }
  
  /* Animaci√≥n de Carga de Reporte */
  #progress-bar-container {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 20px;
      background: rgba(0, 0, 0, 0.8);
      z-index: 55;
      display: none;
  }
  #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--ia), var(--ia-light));
      transition: width 0.5s ease-out;
      position: relative;
  }
  #progress-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #000;
      font-weight: 700;
      font-size: 10px;
      white-space: nowrap;
  }
  
  /*
  =======================================================
  MEDIA QUERIES (RESPONSIVIDAD M√ìVIL) üì±
  =======================================================
  */
  @media(max-width:1024px){
    #main { 
        flex-direction: column; /* Apilamos en m√≥vil */
    }
    #nav-sidebar {
        display: none; /* Ocultamos barra lateral en m√≥vil/tablet peque√±a */
    }
    
    #metrics-panel{
        width: 100%;
        height: 250px; /* Altura fija para el panel en m√≥vil */
        order: 3; /* Se mueve al final */
        min-width: unset;
        box-shadow: 0 -3px 15px rgba(0,0,0,0.5);
    }
    
    #scan-container {
        height: 100%; 
        min-height: 400px; /* Aseguramos que el √°rea de escaneo sea visible */
        order: 1;
    }
    
    /* El bot√≥n de acci√≥n se mueve a una barra inferior si los controles originales fueran muy grandes */
    #action-button-container {
        position: fixed; /* Lo fijamos sobre la c√°mara */
        bottom: 250px; /* Encima del panel de m√©tricas */
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 350px;
        z-index: 51;
    }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div id="main">
    
  <div id="nav-sidebar">
      <h1 style="font-family:Orbitron; font-size:16px; margin-bottom:30px; color:var(--ia)">SIMETR√çA</h1>
      <div class="nav-item active">
          <i class="fas fa-camera"></i> LIVE SCAN
      </div>
      <div class="nav-item">
          <i class="fas fa-chart-line"></i> DATA ANALYTICS
      </div>
      <div class="nav-item">
          <i class="fas fa-project-diagram"></i> PROJECTS
      </div>
      <div class="nav-item">
          <i class="fas fa-cog"></i> SETTINGS
      </div>
      <div class="nav-item" style="margin-top: auto;">
          <i class="fas fa-user-circle"></i> ACCOUNT
      </div>
  </div>

  <div id="scan-container">
      <video id="webcam-feed" autoplay muted playsinline></video>
      <canvas id="capture-canvas"></canvas>

      <div id="placeholder">
        <h2 style="color:var(--ia); font-family:Orbitron;">SYMMETRY AI ENGINE V11.0 ‚Äî OFFLINE</h2>
        <p id="placeholder-msg" style="color:var(--muted)">Active la c√°mara y presione <strong>INICIAR ESCANEO</strong>.</p>
      </div>
      
      <div id="position-feedback" style="display:none;"></div>
      
      <div class="scanning-text" id="scanning-status" style="display:none;">[Processing ‚Üí Locating ‚Üí Analyzing...]</div>

      <div id="action-button-container">
          <button id="main-action-btn" class="btn" disabled>‚ñ∂ INICIAR ESCANEO</button>
      </div>
      
      <div id="progress-bar-container">
          <div id="progress-bar"><span id="progress-message"></span></div>
      </div>
  </div>

  <div id="metrics-panel">
    <h3 style="font-family:Orbitron; font-size:18px; margin-bottom:15px; border-bottom: 2px solid var(--ia); padding-bottom:5px;">KEY METRICS</h3>

    <div class="metric-block">
        <div class="metric-label">√çNDICE DE SIMETR√çA FACIAL (ISF)</div>
        <div id="isf-score" class="score-val">‚Äî</div>
        <small id="isf-feedback" style="color:var(--muted); font-size:10px;">Esperando detecci√≥n...</small>
        <div id="deviation-bar" style="height:10px; background:rgba(255,255,255,0.1); margin-top:5px; position:relative; overflow:hidden; border-radius: 5px;">
            <div id="dev-left" style="position:absolute; left:0; height:100%; width: 50%; background: var(--ia-light); opacity: 0.8; transition: width 0.5s;"></div>
            <div id="dev-right" style="position:absolute; right:0; height:100%; width: 50%; background: var(--accent-error); opacity: 0.8; transition: width 0.5s;"></div>
        </div>
    </div>
    
    <div class="metric-block">
        <div class="metric-label">PROPORCI√ìN √ÅUREA (AESTHETIC SCORE)</div>
        <div id="beauty-score" class="score-val" style="color:var(--accent-warning); text-shadow: none;">‚Äî</div>
        <small style="color:var(--ia-light); font-size:10px;">Basado en 38 puntos de referencia biom√©tricos.</small>
        <canvas id="aurea-donut" width="100" height="100" style="float:right; margin-top:-30px;"></canvas>
    </div>
    
    <div id="report-details" class="metric-block">
      <div class="detail-line"><span class="metric-label" style="display:inline;">EDAD APROX. (IA):</span> <span id="age-score" style="color:var(--ia-light); font-weight:600;">‚Äî</span></div>
      <div class="detail-line"><span class="metric-label" style="display:inline;">ESTADO CIVIL (SIMULADO):</span> <span id="civil-status" style="color:var(--accent-error); font-weight:600;">‚Äî</span></div>
      <div class="detail-line"><span class="metric-label" style="display:inline;">PA√çS DE PERFIL SUGERIDO:</span> <span id="nationality" style="color:var(--accent-warning); font-weight:600;">‚Äî</span></div>
      <small style="color:var(--muted); font-size:10px; display:block; margin-top:5px;">An√°lisis predictivo de patrones de datos faciales.</small>
    </div>
    
    <div class="metric-block">
      <div class="metric-label">EMOCI√ìN DOMINANTE</div>
      <div id="expr-dominant" class="score-val" style="font-size:24px; color:var(--ia-light); text-shadow: none;">‚Äî</div>
      <small id="expr-all" style="display:block; color: var(--muted); font-size: 10px;">Detalle de emociones...</small>
    </div>
    
    <div class="metric-block" style="border-bottom: none;">
      <div class="metric-label">CALIDAD DE ESCANEO Y CONFIANZA (IA)</div>
      <div id="confidence" class="score-val" style="font-size:20px; color:var(--accent-success); text-shadow: 0 0 10px var(--accent-success);">99.8%</div>
    </div>
    
  </div>
  
  <div id="critical-warning" style="display:none;"></div>
</div>

<script src="./face-api.min.js"></script>
<script>
/*
=======================================================
JAVASCRIPT/FACE-API.JS L√ìGICA (V11.0 - CORE)
=======================================================
*/
const MODELS_URL='./models';
// DOM Elements
const main = document.getElementById('main'); 
const video=document.getElementById('webcam-feed');
const canvas=document.getElementById('capture-canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const placeholder=document.getElementById('placeholder');
const placeholderMsg=document.getElementById('placeholder-msg');
const scanningStatus=document.getElementById('scanning-status');
const positionFeedback=document.getElementById('position-feedback');
const criticalWarningEl = document.getElementById('critical-warning');

// HUD Elements
const isfScoreEl=document.getElementById('isf-score');
const isfFeedbackEl=document.getElementById('isf-feedback');
const devLeftEl=document.getElementById('dev-left');
const devRightEl=document.getElementById('dev-right');
const beautyScoreEl=document.getElementById('beauty-score');
const ageScoreEl=document.getElementById('age-score');
const civilStatusEl=document.getElementById('civil-status');
const nationalityEl=document.getElementById('nationality');
const exprDominantEl=document.getElementById('expr-dominant');
const exprAllEl=document.getElementById('expr-all');

// Controls & Progress
const mainActionButton=document.getElementById('main-action-btn');
const progressBarContainer=document.getElementById('progress-bar-container');
const progressBar=document.getElementById('progress-bar');
const progressMessage=document.getElementById('progress-message');

let running=false,raf=null,captured=null, lastDet = null, isLiveScan = true;
let animationTimeout = null;
const ISF_THRESHOLD = 70; // M√≠nimo ISF para activar el bot√≥n CAPTURE

// TRADUCCIONES Y DATOS DE SIMULACI√ìN (Mantenido)
const EXPR_TRADS = {
    'neutral': 'Serenidad', 'happy': 'Alegr√≠a', 'sad': 'Melancol√≠a',
    'angry': 'Ira', 'fearful': 'Temor', 'disgusted': 'Disgusto', 'surprised': 'Sorpresa'
};
const NATIONALITIES = ['Espa√±a', 'M√©xico', 'Colombia', 'Argentina', 'Chile', 'Per√∫', 'Venezuela', 'Italia', 'Francia'];
const CIVIL_STATUS = ['Soltero/a', 'En Relaci√≥n (Pareja)', 'Casado/a (Compromiso)'];
const PROGRESS_PHRASES = ["Compiling Biometric Data...", "Cross-referencing Golden Ratio", "Generating Predictive Analysis...", "Finalizing Report Structure..."];

// SIMULACI√ìN DE DETECCI√ìN DE OBJETOS (ANIMALES)
const ANIMAL_CLASSES = ['Perro', 'Gato', 'P√°jaro', 'Objeto no-facial'];
function checkAnimalDetection(detections) {
    if (detections.length > 0) return null; 
    if (Math.random() < 0.05) { // 5% de probabilidad de detectar un objeto no humano
        return ANIMAL_CLASSES[Math.floor(Math.random() * ANIMAL_CLASSES.length)];
    }
    return null; 
}
function showCriticalWarning(message) {
    criticalWarningEl.innerHTML = `üö® **${message}**`;
    criticalWarningEl.style.display = 'block';
    if(animationTimeout) clearTimeout(animationTimeout);
    animationTimeout = setTimeout(() => {
        criticalWarningEl.style.display = 'none';
    }, 4000);
}


//=== Init models 
async function loadModels(){
  mainActionButton.textContent = 'Cargando IA...';
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL),
    faceapi.nets.ageGenderNet.loadFromUri(MODELS_URL) 
  ]);
  mainActionButton.textContent = '‚ñ∂ INICIAR ESCANEO';
  mainActionButton.disabled=false;
}
window.addEventListener('load',loadModels);

//=== Start camera
mainActionButton.onclick=async()=>{
    if(mainActionButton.textContent.includes('INICIAR ESCANEO')){
        try{
            placeholderMsg.textContent = 'Solicitando permiso de c√°mara al sistema...';
            const stream=await navigator.mediaDevices.getUserMedia({video:true});
            video.srcObject=stream; await video.play();
            placeholder.style.display='none';
            resizeCanvas(); running=true; loop();
            isLiveScan = true;
            mainActionButton.textContent = 'üì∏ CAPTURAR DATOS';
            mainActionButton.classList.remove('primary');
            mainActionButton.disabled = true;
            scanningStatus.style.display = 'block';
            resetHUDLive();
        }catch(e){
            placeholderMsg.textContent = 'ERROR C√ÅMARA: No se pudo acceder. Revise los permisos.';
            showCriticalWarning('ERROR C√ÅMARA: No se pudo acceder. Aseg√∫rese de tener permisos.');
        }
    } else if (mainActionButton.textContent.includes('CAPTURAR DATOS')) {
        captureData();
    } else if (mainActionButton.textContent.includes('DESCARGAR REPORTE')) {
        downloadReport();
    } else if (mainActionButton.textContent.includes('REANUDAR')) {
        retryScan();
    }
};

//=== Resize canvas
function resizeCanvas(){
  const displaySize = { width: video.clientWidth, height: video.clientHeight };
  faceapi.matchDimensions(canvas, displaySize);
}
window.addEventListener('resize',resizeCanvas);
video.addEventListener('play', resizeCanvas);


//=== Live detection loop 
async function loop(){
  if(!running)return;
  const displaySize = { width: canvas.width, height: canvas.height };
  
  const det=await faceapi.detectAllFaces(video,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();
  
  const resized=faceapi.resizeResults(det, displaySize);
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // DIBUJAR MALLA FACIAL AVANZADA
  if(det.length > 0) {
    faceapi.draw.drawFaceLandmarks(canvas,resized, { drawLines: true, drawPoints: true, lineWidth: 1.5, color: 'rgba(0,255,255,0.7)' });
  }

  // >>> L√ìGICA DE BLOQUEO POR DETECCI√ìN DE OBJETOS/ANIMALES <<<
  const animalDetected = checkAnimalDetection(det); 

  if (animalDetected) {
      // Bloqueo total
      mainActionButton.disabled = true;
      mainActionButton.classList.remove('primary');
      lastDet = null;
      showCriticalWarning(`DETECCI√ìN DE OBJETO: ${animalDetected}. AN√ÅLISIS EXCLUSIVO PARA SERES HUMANOS.`);
      positionFeedback.style.opacity = 0;
      resetHUDLive();

  } else if(det.length > 0){
      // Rostro humano detectado - Flujo normal
      criticalWarningEl.style.display = 'none';
      lastDet = det[0];
      const score=calcSymmetry(lastDet);
      
      // Actualizar HUD
      updateLiveMetrics(score, lastDet.expressions);
      
      // Feedback de Posicionamiento
      if (score > ISF_THRESHOLD) {
          positionFeedback.textContent = 'Rostro detectado y listo üü¢ (Posici√≥n Perfecta)';
          positionFeedback.style.color = 'var(--accent-success)';
          mainActionButton.disabled = false;
          mainActionButton.classList.add('primary');
      } else {
          positionFeedback.textContent = 'Ac√©rquese/ajuste ligeramente la cabeza...';
          positionFeedback.style.color = 'var(--accent-warning)';
          mainActionButton.disabled = true;
          mainActionButton.classList.remove('primary');
      }
      positionFeedback.style.opacity = 1;

  } else {
    // No hay detecciones (ni rostros ni animales)
    criticalWarningEl.style.display = 'none';
    lastDet = null;
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    resetHUDLive();
    
    positionFeedback.textContent = 'Buscando rostro humano...';
    positionFeedback.style.color = 'var(--ia)';
    positionFeedback.style.opacity = 1;
  }

  raf=requestAnimationFrame(loop);
}

//=== Live Metrics Update (V11)
function updateLiveMetrics(score, expressions) {
    // ISF Score
    animateScore(isfScoreEl, score.toFixed(2));
    isfFeedbackEl.textContent = updateScoreFeedback(score, false);
    
    // Simulaci√≥n de Gr√°fico de Desviaci√≥n
    const deviation = Math.abs(50 - (score / 100) * 50); // M√≠nima desviaci√≥n 0, M√°xima 50%
    devLeftEl.style.width = `${50 + deviation}%`;
    devRightEl.style.width = `${50 - deviation}%`;
    devLeftEl.style.backgroundColor = score > 85 ? 'var(--accent-success)' : 'var(--accent-warning)';

    // Proporci√≥n √Åurea (Punt. Est√©tica)
    animateScore(beautyScoreEl, calcBeautyScore(score).toFixed(2) + '/10', 10);
    drawAureaDonut(calcBeautyScore(score) * 10);
    
    // Emoci√≥n Dominante
    updateEmotionDisplay(expressions, false);
}


//=== Capture Data (Bot√≥n üì∏)
function captureData(){
    if(!lastDet) return;
    
    running=false; cancelAnimationFrame(raf); video.pause();
    scanningStatus.style.display = 'none';
    positionFeedback.style.opacity = 0;
    
    // 1. Captura de Imagen de Alta Res. (sin espejo y con malla final)
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.save();
    tempCtx.scale(-1, 1); 
    tempCtx.drawImage(video, -tempCanvas.width, 0, tempCanvas.width, tempCanvas.height);
    tempCtx.restore();
    
    const resizedForDownload = faceapi.resizeResults([lastDet], { width: tempCanvas.width, height: tempCanvas.height });
    faceapi.draw.drawFaceLandmarks(tempCanvas, resizedForDownload, { drawLines: true, drawPoints: true, lineWidth: 2, color: 'rgba(0,255,255,0.9)' });
    captured=tempCanvas.toDataURL('image/png');
    
    // 2. Congelar el Canvas de Visualizaci√≥n (para el usuario)
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const img=new Image(); 
    img.src=captured; 
    img.onload = () => { ctx.drawImage(img,0,0,canvas.width,canvas.height); };
    
    // 3. Iniciar el Flujo de An√°lisis
    startAnalysisFlow(lastDet);
}

//=== Flujo de An√°lisis con Barra de Progreso (V11)
async function startAnalysisFlow(det) {
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    mainActionButton.textContent = '‚öôÔ∏è PROCESANDO DATOS...';

    // Iniciar Barra de Progreso
    progressBarContainer.style.display = 'block';
    let currentProgress = 0;
    let step = 1;

    const progressInterval = setInterval(() => {
        if (currentProgress < 95) {
            currentProgress += Math.random() * 5 + 1; // Incremento r√°pido y variable
            currentProgress = Math.min(currentProgress, 95);
            progressBar.style.width = `${currentProgress}%`;
            
            // Actualizar mensaje de progreso
            if (currentProgress > 25 && step === 1) {
                progressMessage.textContent = PROGRESS_PHRASES[0]; step++;
            } else if (currentProgress > 50 && step === 2) {
                progressMessage.textContent = PROGRESS_PHRASES[1]; step++;
            } else if (currentProgress > 75 && step === 3) {
                progressMessage.textContent = PROGRESS_PHRASES[2]; step++;
            }
        }
    }, 500);

    // Simular Carga y Ejecutar Detecciones Adicionales (Age/Gender)
    await simulateAnalysisDelay(4000); 

    // DETECCI√ìN FINAL
    const img=new Image(); 
    img.src=captured; await new Promise(r=>img.onload=r);
    const dets=await faceapi.detectAllFaces(img,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
        .withFaceLandmarks().withFaceExpressions().withAgeAndGender();
    
    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    progressMessage.textContent = 'AN√ÅLISIS COMPLETADO. Generando Reporte Final...';
    
    // Transici√≥n suave (fade out) de la barra
    setTimeout(() => {
        progressBarContainer.style.display = 'none';
        transitionToDataAnalytics(dets[0]);
    }, 1000);
}

//=== Transici√≥n a Data Analytics (V11)
function transitionToDataAnalytics(finalDet) {
    const symmetryScore=calcSymmetry(finalDet);
    const beautyScoreNumber=calcBeautyScore(symmetryScore);
    const simulatedNationality = simulateNationality(beautyScoreNumber);
    const simulatedCivilStatus = simulateCivilStatus(finalDet.expressions);

    // DIBUJAR LAS DETECCIONES FINALES EN EL CANVAS DE VISUALIZACI√ìN
    const resized=faceapi.resizeResults([finalDet],{width:canvas.width,height:canvas.height});
    faceapi.draw.drawDetections(canvas,resized, {boxColor: 'var(--accent-success)', lineWidth: 3});
    faceapi.draw.drawFaceExpressions(canvas,resized, 0.05);

    // Actualizar Panel de M√©tricas
    isfScoreEl.textContent = symmetryScore.toFixed(2);
    isfFeedbackEl.textContent = updateScoreFeedback(symmetryScore, true);
    beautyScoreEl.textContent = beautyScoreNumber.toFixed(2) + '/10';
    ageScoreEl.textContent = `${Math.round(finalDet.age)} a√±os (G√©nero: ${finalDet.gender === 'male' ? 'Masc.' : 'Fem.'})`;
    civilStatusEl.textContent = simulatedCivilStatus;
    nationalityEl.textContent = simulatedNationality;
    updateEmotionDisplay(finalDet.expressions, true);
    
    // Finalizar controles
    mainActionButton.textContent = '‚¨áÔ∏è DESCARGAR REPORTE';
    mainActionButton.classList.add('primary');
    mainActionButton.disabled = false;
    
    // Simular la notificaci√≥n flotante (snackbar)
    const snackbar = document.createElement('div');
    snackbar.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--panel-bg); color:var(--ia); padding:10px 15px; border-radius:8px; border:1px solid var(--ia); z-index:100; font-size:14px;';
    snackbar.textContent = 'Reporte Simetr√≠a Engine Pro #2025-001 listo. Descargando...';
    document.body.appendChild(snackbar);
    setTimeout(() => {
        document.body.removeChild(snackbar);
    }, 3000);
}

//=== Retry (Reanudar Webcam)
function retryScan(){
    running=true; video.play();
    isLiveScan = true;
    mainActionButton.textContent = 'üì∏ CAPTURAR DATOS';
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    scanningStatus.style.display = 'block';
    positionFeedback.style.opacity = 1;
    resetHUDLive(true);
    raf=requestAnimationFrame(loop);
}

//=== Download capture (Simulado)
function downloadReport(){
    // La descarga ya incluye el overlay de datos y las detecciones
    if(!captured)return;
    const a=document.createElement('a');
    a.href=captured;
    a.download='SYMMETRY_ANALYSIS_V11.0_REPORTE.png';
    a.click();
}

/*
=======================================================
L√ìGICA DE C√ÅLCULO Y SIMULACI√ìN (HELPERS)
=======================================================
*/
function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}

function calcSymmetry(det){
  try{
    const lm=det.landmarks;
    const left=centroid(lm.getLeftEye()),right=centroid(lm.getRightEye()),nose=centroid(lm.getNose()),mouth=centroid(lm.getMouth());
    const dL=dist(left,nose),dR=dist(right,nose);
    const balance=1-Math.abs(dL-dR)/Math.max(dL,dR);
    const mouthSym=1-Math.abs(mouth.x-nose.x)/(canvas.width*0.05);
    const phi=1.618;
    const ratio=(dL+dR)/(dist(left,right)||1);
    const phiScore=1-Math.abs(ratio-ratio/phi)/(ratio/phi);
    const score=Math.max(0,Math.min(100,(balance*0.5+mouthSym*0.3+phiScore*0.2)*100));
    return score;
  }catch(e){return 0;}
}

function calcBeautyScore(isf){return (isf/100) * 10;} // Convierte 0-100 a 0-10
function simulateNationality(beautyScore){
    const index = Math.floor(Math.random() * NATIONALITIES.length);
    let nationality = NATIONALITIES[index];
    if (beautyScore > 9.0) {
        nationality = 'Perfil ' + NATIONALITIES[Math.floor(Math.random() * 3)];
    }
    return nationality + ' (' + (Math.random() * 20 + 75).toFixed(1) + '% Confianza)';
}
function simulateCivilStatus(expressions){
    const dominant = Object.entries(expressions).sort((a,b)=>b[1]-a[1])[0][0];
    let status = CIVIL_STATUS[0]; 
    if (dominant === 'happy' || dominant === 'neutral') {
        const rand = Math.random();
        if (rand < 0.4) status = CIVIL_STATUS[1]; 
        else if (rand < 0.7) status = CIVIL_STATUS[2];
    }
    return status;
}

function updateScoreFeedback(score, finalReport){
    let feedback = '';
    if(score > 90){feedback = finalReport ? 'Nivel A++: Simetr√≠a Perfecta. Optimal Biometrics.' : '√ìptimo. Simetr√≠a √âlite detectada.';} 
    else if(score > 80){feedback = finalReport ? 'Nivel A+: Alta Simetr√≠a. Excelente Biometr√≠a.' : 'Superior. Mantenga la posici√≥n.';} 
    else if(score > 70){feedback = finalReport ? 'Nivel B: Simetr√≠a Adecuada. Balance Promedio.' : 'Est√°ndar. Ajuste el encuadre.';} 
    else {feedback = finalReport ? 'Nivel C: Se detectan desviaciones de la l√≠nea central.' : 'Bajo. Mueva el rostro.';}
    return feedback;
}

function updateEmotionDisplay(expressions, fullReport = false){
  const sorted=Object.entries(expressions).sort((a,b)=>b[1]-a[1]);
  const dominant = sorted[0][0];
  const dominantPercent = (sorted[0][1]*100).toFixed(1);
  exprDominantEl.textContent = `${EXPR_TRADS[dominant]}`;
  exprAllEl.textContent = `(${dominantPercent}% ${EXPR_TRADS[dominant]}, ` + sorted.slice(1, 3).map(e=>e[1]*100>5?e[1]*100+'% '+EXPR_TRADS[e[0]]:'').filter(Boolean).join(', ') + ')';

  if(fullReport){
      // Visualizaci√≥n de nube de tags/detalle de emociones
      exprAllEl.innerHTML = `Nube de Tags: ${sorted.map(e=>e[1]*100>5?`<b>${(e[1]*100).toFixed(0)}% ${EXPR_TRADS[e[0]]}</b>`:'').filter(Boolean).join(' | ')}`;
  } else {
      exprAllEl.innerHTML = `An√°lisis de emoci√≥n en tiempo real...`;
  }
}
function resetHUDLive(isRetry = false){
  isfScoreEl.textContent = '‚Äî';
  isfFeedbackEl.textContent = isRetry ? 'Reanudando detecci√≥n en tiempo real...' : 'Esperando entrada biom√©trica.';
  devLeftEl.style.width = '50%';
  devRightEl.style.width = '50%';
  beautyScoreEl.textContent = '‚Äî';
  drawAureaDonut(0);
  ageScoreEl.textContent = '‚Äî';
  civilStatusEl.textContent = '‚Äî';
  nationalityEl.textContent = '‚Äî';
  exprDominantEl.textContent = '‚Äî';
  exprAllEl.innerHTML = 'Detalle de emociones...';
  // confidence ya est√° fijo en 99.8%
}

// Simulaci√≥n de Animaci√≥n de Puntuaci√≥n (Tween)
function animateScore(element, targetValue, maxValue = 100) {
    const currentValue = parseFloat(element.textContent.replace(/[^\d.]/g, '')) || 0;
    const targetNumber = parseFloat(targetValue.replace(/[^\d.]/g, '')) || 0;
    
    let startTime;
    const duration = 200; // 200ms de duraci√≥n

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const percentage = Math.min(progress / duration, 1);

        const easedProgress = percentage; // Usamos un easing simple (lineal)
        const value = currentValue + (targetNumber - currentValue) * easedProgress;

        if (element.id === 'beauty-score') {
            element.textContent = `${value.toFixed(1)}/10`;
        } else {
            element.textContent = value.toFixed(2);
        }

        if (percentage < 1) {
            raf = requestAnimationFrame(step);
        } else {
            if (element.id === 'beauty-score') {
                element.textContent = targetValue; // Asegurar el valor final
            } else {
                element.textContent = targetValue;
            }
        }
    }
    requestAnimationFrame(step);
}

// Dibujar Gr√°fico de Dona (Simulado)
function drawAureaDonut(score) { // score es 0-100
    const canvasEl = document.getElementById('aurea-donut');
    const ctx = canvasEl.getContext('2d');
    const center = 50;
    const radius = 40;
    const lineWidth = 6;
    const endAngle = Math.PI * 2 * (score / 100) - Math.PI / 2;

    ctx.clearRect(0, 0, 100, 100);

    // Fondo (Gris)
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.lineWidth = lineWidth;
    ctx.stroke();

    // Progreso (Cian/Amarillo)
    ctx.beginPath();
    ctx.arc(center, center, radius, -Math.PI / 2, endAngle);
    ctx.strokeStyle = score > 70 ? 'var(--ia)' : 'var(--accent-warning)';
    ctx.lineWidth = lineWidth;
    ctx.stroke();

    // Texto Central (Opcional, la puntuaci√≥n est√° al lado)
    // ctx.fillStyle = 'var(--ia-light)';
    // ctx.font = 'bold 16px Orbitron';
    // ctx.textAlign = 'center';
    // ctx.fillText(score.toFixed(0) + '%', center, center + 5);
}


async function simulateAnalysisDelay(ms){
    await new Promise(r => setTimeout(r, ms));
}

</script>
</body>
</html>
