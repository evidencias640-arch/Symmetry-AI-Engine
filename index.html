<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SYMMETRY AI ENGINE PRO V5 ‚Äî Fullscreen Facial Analysis</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@300;600&display=swap');
  :root{--ia:#00ffff;--ia2:#66ffff;--bg:#000b11;--muted:#a0a9b5;}
  body,html{margin:0;padding:0;width:100%;height:100%;background:var(--bg);color:#e6f9ff;font-family:Inter,Arial,sans-serif;overflow:hidden;}
  #main{position:relative;width:100%;height:100vh;overflow:hidden;}
  #webcam-feed,#capture-canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
  #placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);z-index:5;text-align:center;}
  #controls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:10;flex-wrap:wrap;justify-content:center;}
  .btn{background:rgba(0,0,0,0.6);border:1px solid rgba(0,255,255,0.2);color:var(--ia);padding:10px 16px;border-radius:8px;cursor:pointer;backdrop-filter:blur(6px);font-weight:600;transition:background .2s;}
  .btn:hover{background:rgba(0,255,255,0.15);}
  .primary{background:linear-gradient(90deg,var(--ia),var(--ia2));color:#001;}
  #results{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;font-size:13px;z-index:10;backdrop-filter:blur(6px);}
  #score{font-family:Orbitron,Inter,Arial;font-size:28px;font-weight:800;}
  #progress{width:100px;height:6px;background:#001;border-radius:999px;overflow:hidden;margin-top:4px;}
  #progress>div{height:100%;width:0%;background:var(--ia);transition:width .4s ease,background .4s;}
  @media(max-width:300px){
    #results{font-size:11px;}
    #controls{bottom:4px;gap:6px;}
    .btn{padding:8px 10px;font-size:12px;}
  }
</style>
</head>
<body>
<div id="main">
  <video id="webcam-feed" autoplay muted playsinline></video>
  <canvas id="capture-canvas"></canvas>
  <div id="placeholder">
    <h2 style="color:var(--ia)">SUBSISTEMA INACTIVO</h2>
    <p style="color:var(--muted)">Active la c√°mara y presione <strong>Iniciar</strong>.</p>
  </div>

  <div id="results">
    <div><b>Rostros:</b> <span id="count">0</span></div>
    <div id="score">‚Äî</div>
    <div id="progress"><div></div></div>
    <div id="expr" style="margin-top:6px;color:var(--muted)"></div>
  </div>

  <div id="controls">
    <button id="start" class="btn">Iniciar</button>
    <button id="capture" class="btn primary" disabled>üì∏ Capturar</button>
    <button id="analyze" class="btn" style="display:none">‚öôÔ∏è Analizar</button>
    <button id="retry" class="btn" style="display:none">üîÑ Reanudar</button>
    <button id="download" class="btn" style="display:none">‚¨áÔ∏è Guardar</button>
  </div>
</div>

<script src="./face-api.min.js"></script>
<script>
const MODELS_URL='./models';
const video=document.getElementById('webcam-feed');
const canvas=document.getElementById('capture-canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const placeholder=document.getElementById('placeholder');
const btnStart=document.getElementById('start');
const btnCapture=document.getElementById('capture');
const btnAnalyze=document.getElementById('analyze');
const btnRetry=document.getElementById('retry');
const btnDownload=document.getElementById('download');
const countEl=document.getElementById('count');
const scoreEl=document.getElementById('score');
const progressBar=document.querySelector('#progress>div');
const exprEl=document.getElementById('expr');
let running=false,raf=null,captured=null;

//=== Init models
async function loadModels(){
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL)
  ]);
  btnStart.disabled=false;
}
window.addEventListener('load',loadModels);

//=== Start camera
btnStart.onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream; await video.play();
    placeholder.style.display='none';
    btnStart.disabled=true; btnCapture.disabled=false;
    resizeCanvas(); running=true; loop();
  }catch(e){alert('Error c√°mara: '+e.message);}
};

//=== Resize canvas to full screen
function resizeCanvas(){
  canvas.width=video.videoWidth||window.innerWidth;
  canvas.height=video.videoHeight||window.innerHeight;
}
window.addEventListener('resize',resizeCanvas);

//=== Live detection loop
async function loop(){
  if(!running)return;
  resizeCanvas();
  const det=await faceapi.detectAllFaces(video,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const resized=faceapi.resizeResults(det,{width:canvas.width,height:canvas.height});
  faceapi.draw.drawDetections(canvas,resized);
  faceapi.draw.drawFaceLandmarks(canvas,resized);
  faceapi.draw.drawFaceExpressions(canvas,resized);
  countEl.textContent=det.length;
  progressBar.style.width=det.length?'25%':'4%';
  raf=requestAnimationFrame(loop);
}

//=== Capture image
btnCapture.onclick=()=>{
  running=false; cancelAnimationFrame(raf); video.pause();
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  captured=canvas.toDataURL('image/png');
  btnAnalyze.style.display='inline-block';
  btnRetry.style.display='inline-block';
  btnDownload.style.display='inline-block';
};

//=== Analyze captured
btnAnalyze.onclick=async()=>{
  if(!captured){alert('Sin captura');return;}
  btnAnalyze.disabled=true;
  exprEl.textContent='Analizando...'; progressBar.style.width='5%';
  const dets=await faceapi.detectAllFaces(canvas,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const img=new Image(); img.src=captured; await new Promise(r=>img.onload=r);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const resized=faceapi.resizeResults(dets,{width:canvas.width,height:canvas.height});
  faceapi.draw.drawDetections(canvas,resized);
  faceapi.draw.drawFaceLandmarks(canvas,resized);
  faceapi.draw.drawFaceExpressions(canvas,resized);
  countEl.textContent=dets.length;
  if(!dets.length){scoreAnimate('‚Äî');exprEl.textContent='No se detect√≥ rostro';btnAnalyze.disabled=false;return;}
  const score=calcSymmetry(dets[0]);
  scoreAnimate(score.toFixed(2));
  updateProgressColor(score);
  const exprs=dets[0].expressions;
  const sorted=Object.entries(exprs).sort((a,b)=>b[1]-a[1]);
  exprEl.innerHTML='<b>Expresi√≥n dominante:</b> '+sorted[0][0]+' ('+(sorted[0][1]*100).toFixed(1)+'%)<br>'
    +'<small>'+sorted.map(e=>e[0]+': '+(e[1]*100).toFixed(0)+'%').join(' ¬∑ ')+'</small>';
  progressBar.style.width='100%';
  btnAnalyze.disabled=false;
};

//=== Retry
btnRetry.onclick=()=>{
  running=true; video.play(); btnAnalyze.style.display='none';btnRetry.style.display='none';btnDownload.style.display='none';
  raf=requestAnimationFrame(loop);
};

//=== Download capture
btnDownload.onclick=()=>{
  if(!captured)return;
  const a=document.createElement('a');a.href=captured;a.download='captura_ai.png';a.click();
};

//=== Helpers
function calcSymmetry(det){
  try{
    const lm=det.landmarks;
    const left=centroid(lm.getLeftEye()),right=centroid(lm.getRightEye()),nose=centroid(lm.getNose()),mouth=centroid(lm.getMouth());
    const dL=dist(left,nose),dR=dist(right,nose);
    const balance=1-Math.abs(dL-dR)/Math.max(dL,dR);
    const mouthSym=1-Math.abs(mouth.x-nose.x)/(canvas.width*0.05);
    const phi=1.618; const ratio=(dL+dR)/(dist(left,right)||1);
    const phiScore=1-Math.abs(ratio-phi/2)/(phi/2);
    const score=Math.max(0,Math.min(100,(balance*0.5+mouthSym*0.3+phiScore*0.2)*100));
    return score;
  }catch(e){return 0;}
}
function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}
function scoreAnimate(val){
  const el=document.getElementById('score');
  el.style.transform='scale(0.8)';setTimeout(()=>{el.textContent=val;el.style.transform='scale(1)';},160);
}
function updateProgressColor(score){
  const c=score<50?'#ff5050':score<75?'#ffaa00':'#00ffb3';
  progressBar.style.background=c;
}
</script>
</body>
</html>
