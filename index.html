<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SYMMETRY AI ENGINE PRO V8 ‚Äî An√°lisis Biom√©trico y Est√©tico</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /*
  =======================================================
  ESTILOS BASE Y VARIABLES (V8 - √ânfasis en Responsividad y Scan)
  =======================================================
  */
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@300;600&display=swap');
  :root{
    --ia:#00ffff; /* Cian principal */
    --ia-light:#66ffff;
    --ia-glow: 0 0 10px var(--ia), 0 0 20px rgba(0,255,255,0.6);
    --bg:#000b11;
    --muted:#a0a9b5;
    --accent-error:#ff5050;
    --accent-warning:#ffaa00;
    --accent-success:#00ffb3;
    --shadow-light: 0 0 8px var(--ia), 0 0 12px var(--ia-light);
  }

  body,html{
    margin:0;padding:0;width:100%;height:100%;background:var(--bg);
    color:#e6f9ff;font-family:Inter,Arial,sans-serif;overflow:hidden;
  }
  #main{position:relative;width:100%;height:100vh;overflow:hidden;}

  /*
  =======================================================
  VIDEO Y CANVAS
  =======================================================
  */
  #webcam-feed,#capture-canvas{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;
  }
  #capture-canvas{
    box-shadow: 0 0 15px rgba(0,255,255,0.5) inset;
    border: 1px solid rgba(0,255,255,0.3);
  }

  /*
  =======================================================
  ANIMACI√ìN DE ESCANEO (AUREOLA AZUL) - SOLO EN MODO LIVE
  =======================================================
  */
  @keyframes scan-line {
    0% { transform: translateY(-100%) }
    100% { transform: translateY(100%) }
  }
  .scanner-active::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      to bottom,
      rgba(0, 255, 255, 0) 0%,
      rgba(0, 255, 255, 0.4) 50%,
      rgba(0, 255, 255, 0) 100%
    );
    opacity: 0.5;
    animation: scan-line 3s infinite alternate ease-in-out;
    pointer-events: none; /* Asegura que no interfiera con eventos del mouse */
    z-index: 5;
  }

  /*
  =======================================================
  HUD / INTERFAZ DE RESULTADOS (RESPONSIVE)
  =======================================================
  */
  #results{
    position:absolute;
    top:10px;
    right:10px;
    background:rgba(0,0,0,0.85);
    border: 2px solid rgba(0,255,255,0.3);
    padding:16px;
    border-radius:8px;
    font-size:14px;
    z-index:10;
    backdrop-filter:blur(12px);
    box-shadow: var(--ia-glow);
    max-width: 320px;
    transition: all 0.3s ease;
  }

  .metric-label{
    font-family: Orbitron, Inter, Arial;
    font-weight: 800;
    color: var(--ia-light);
    margin-top: 10px;
    text-shadow: 0 0 5px rgba(0,255,255,0.5);
    border-bottom: 1px solid rgba(0,255,255,0.2);
    padding-bottom: 2px;
    letter-spacing: 1px;
    font-size: 0.85em;
  }

  .score-val{
    font-family:Orbitron,Inter,Arial;font-size:36px;font-weight:800;
    line-height: 1;
    margin-top: 4px;
    color: var(--ia-light);
    text-shadow: var(--ia-glow);
    transition: transform 0.1s;
  }

  #progress{
    width:100%;height:8px;background:#001;border-radius:999px;
    overflow:hidden;margin-top:6px;
    box-shadow: 0 0 5px rgba(0,255,255,0.4) inset;
  }
  #progress>div{
    height:100%;
    width:0%;
    transition:width .8s ease, background .8s;
    box-shadow: 0 0 8px rgba(0,255,255,1);
  }

  /* Detalles del reporte final (Para el pa√≠s y m√°s) */
  #report-details {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed rgba(0,255,255,0.2);
  }

  /*
  =======================================================
  CONTROLES / BOTONES (RESPONSIVE)
  =======================================================
  */
  #controls{
    position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;z-index:20;flex-wrap:wrap;justify-content:center;
    width: 95%; /* Asegura que no se desborden en m√≥viles */
    max-width: 600px;
  }
  .btn{
    flex-grow: 1; /* Permite que los botones se estiren */
    min-width: 120px;
    background:rgba(0,0,0,0.8);
    border:2px solid rgba(0,255,255,0.4);
    color:var(--ia);
    padding:12px 16px;
    border-radius:10px;
    cursor:pointer;
    backdrop-filter:blur(10px);
    font-weight:700;
    transition:background .3s, transform .2s, box-shadow .3s;
    font-family: Inter, Arial;
    letter-spacing: 0.5px;
    font-size: 14px;
    box-shadow: 0 0 5px rgba(0,255,255,0.3);
  }
  .btn:hover:not(:disabled){
    background:rgba(0,255,255,0.25);
    box-shadow: var(--ia-glow);
    transform: translateY(-2px) scale(1.01);
  }
  .primary{
    font-family: Orbitron, Inter, Arial;
    background:linear-gradient(90deg,var(--ia),var(--ia-light));
    color:#000;
    border-color: var(--ia-light);
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /*
  =======================================================
  MEDIA QUERIES (RESPONSIVIDAD M√ìVIL CR√çTICA) üì±
  =======================================================
  */
  @media(max-width:600px){
    /* Mueve resultados al centro/abajo */
    #results{
      top: auto;
      bottom: 60px; /* Sobre los controles */
      right: 50%;
      transform: translateX(50%);
      width: 95%;
      padding: 12px;
      margin-bottom: 50px;
    }
    .score-val{font-size:28px;}
    .metric-label{font-size: 0.8em; margin-top: 8px;}
    
    #controls{
      bottom: 4px;
      gap: 5px;
      width: 98%;
    }
    .btn{
      padding: 10px 8px;
      font-size: 12px;
      min-width: unset;
      flex-grow: 1;
    }
    /* El bot√≥n de iniciar debe ser grande */
    #start { flex-grow: 2; }
    /* Para el modo de an√°lisis, los botones deben ser m√°s compactos */
    #controls button:nth-child(3),
    #controls button:nth-child(4),
    #controls button:nth-child(5) { min-width: unset; flex-grow: 1; }
  }
</style>
</head>
<body>
<div id="main">
  <video id="webcam-feed" autoplay muted playsinline></video>
  <canvas id="capture-canvas"></canvas>

  <div id="placeholder">
    <h2 style="color:var(--ia)">SYMMETRY AI ENGINE V8 ‚Äî M√ìDULO INACTIVO</h2>
    <p style="color:var(--muted)">Procesador de Imagen Desconectado. Active la c√°mara y presione <strong>INICIAR DETECCI√ìN</strong>.</p>
  </div>

  <div id="results">
    <div><b>DETECCIONES ACTIVAS:</b> <span id="count">0</span></div>

    <div class="metric-label">√çNDICE DE SIMETR√çA (ISF)</div>
    <div id="score" class="score-val">‚Äî</div>
    <div id="progress"><div></div></div>
    <div id="score-feedback" style="font-size:12px; margin-top:4px;">Inicie el an√°lisis biom√©trico.</div>

    <div id="report-details">
      <div style="margin-bottom: 5px;"><span class="metric-label" style="border:none;">EMOCI√ìN DOMINANTE:</span> <span id="expr-dominant" style="color:var(--ia-light); font-weight:600;">‚Äî</span></div>
      <div id="beauty-score-line" style="display:none;"><span class="metric-label" style="border:none;">PUNT. EST√âTICA (PROPORCI√ìN √ÅUREA):</span> <span id="beauty-score" class="score-val" style="font-size:16px;">‚Äî</span></div>
      <div id="nationality-line" style="display:none;"><span class="metric-label" style="border:none;">PA√çS DE PERFIL SUGERIDO:</span> <span id="nationality" style="color:var(--accent-warning); font-weight:600;">‚Äî</span></div>
      <small id="expr-all" style="display:block; margin-top: 4px; color: var(--muted); font-size: 10px;">M√©tricas secundarias...</small>
    </div>
  </div>

  <div id="controls">
    <button id="start" class="btn">‚ñ∂ INICIAR DETECCI√ìN</button>
    <button id="capture" class="btn primary" disabled>üì∏ CAPTURAR Y CONGELAR</button>
    <button id="analyze" class="btn" style="display:none">‚öôÔ∏è ANALIZAR AVANZADO</button>
    <button id="retry" class="btn" style="display:none">üîÑ REANUDAR WEBCAM</button>
    <button id="download" class="btn" style="display:none">‚¨áÔ∏è DESCARGAR REPORTE</button>
  </div>
</div>

<script src="./face-api.min.js"></script>
<script>
/*
=======================================================
JAVASCRIPT/FACE-API.JS L√ìGICA (V8)
=======================================================
*/
const MODELS_URL='./models';
// Elementos DOM
const video=document.getElementById('webcam-feed');
const canvas=document.getElementById('capture-canvas');
const countEl=document.getElementById('count');
const scoreEl=document.getElementById('score');
const progressBar=document.querySelector('#progress>div');
const scoreFeedbackEl=document.getElementById('score-feedback');
const exprDominantEl=document.getElementById('expr-dominant');
const exprAllEl=document.getElementById('expr-all');
const beautyScoreEl=document.getElementById('beauty-score');
const beautyScoreLine=document.getElementById('beauty-score-line');
const nationalityEl=document.getElementById('nationality');
const nationalityLine=document.getElementById('nationality-line');
const btnStart=document.getElementById('start');
const btnCapture=document.getElementById('capture');
const btnAnalyze=document.getElementById('analyze');
const btnRetry=document.getElementById('retry');
const btnDownload=document.getElementById('download');

let running=false,raf=null,captured=null;

// TRADUCCIONES Y DATOS DE SIMULACI√ìN
const EXPR_TRADS = {
    'neutral': 'Neutralidad', 'happy': 'Satisfacci√≥n', 'sad': 'Melancol√≠a',
    'angry': 'Ira', 'fearful': 'Temor', 'disgusted': 'Disgusto', 'surprised': 'Sorpresa'
};
const NATIONALITIES = ['Espa√±a', 'M√©xico', 'Colombia', 'Argentina', 'Chile', 'Per√∫', 'Venezuela'];
const FEMALE_NAMES = ['Elena', 'Sof√≠a', 'Andrea', 'Valeria', 'Camila'];
const MALE_NAMES = ['Javier', 'Alejandro', 'Mateo', 'Daniel', 'Santiago'];

//=== Init models
async function loadModels(){
  btnStart.textContent = 'Cargando IA...';
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL)
  ]);
  btnStart.textContent = '‚ñ∂ INICIAR DETECCI√ìN';
  btnStart.disabled=false;
}
window.addEventListener('load',loadModels);

//=== Start camera
btnStart.onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream; await video.play();
    document.getElementById('placeholder').style.display='none';
    btnStart.style.display='none'; btnCapture.disabled=false;
    resizeCanvas(); running=true; loop();
    canvas.classList.add('scanner-active'); // A√±ade la animaci√≥n del esc√°ner
  }catch(e){alert('Error al acceder a la c√°mara: '+e.message);}
};

//=== Resize canvas
function resizeCanvas(){
  canvas.width=video.videoWidth||window.innerWidth;
  canvas.height=video.videoHeight||window.innerHeight;
}
window.addEventListener('resize',resizeCanvas);

//=== Live detection loop
async function loop(){
  if(!running)return;
  resizeCanvas();
  const det=await faceapi.detectAllFaces(video,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const resized=faceapi.resizeResults(det,{width:canvas.width,height:canvas.height});

  // Dibujar solo los puntos clave de biometr√≠a en el modo live
  faceapi.draw.drawFaceLandmarks(canvas,resized);

  countEl.textContent=det.length;
  if(det.length > 0){
    const score=calcSymmetry(det[0]);
    scoreAnimate(score);
    updateProgressColor(score);
    updateEmotionDisplay(det[0].expressions, false); // No reporte completo
    scoreFeedbackEl.textContent = 'Detecci√≥n Bi-Dimensional Activa. Capture para An√°lisis Profundo.';
    progressBar.style.width='30%';
  } else {
    resetHUDLive();
  }

  raf=requestAnimationFrame(loop);
}

//=== Capture image
btnCapture.onclick=()=>{
  if(parseInt(countEl.textContent) === 0){
    alert('ALERTA: Se requiere un rostro detectado para el proceso de captura.');
    return;
  }
  running=false; cancelAnimationFrame(raf); video.pause();
  canvas.classList.remove('scanner-active'); // Detiene la animaci√≥n del esc√°ner
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  captured=canvas.toDataURL('image/png');

  btnCapture.style.display='none';
  btnAnalyze.style.display='inline-block';
  btnRetry.style.display='inline-block';
  btnDownload.style.display='inline-block';
  btnAnalyze.disabled=false;

  scoreFeedbackEl.textContent = 'IMAGEN CONGELADA. Listo para An√°lisis Avanzado.';
  progressBar.style.width='5%';
};

//=== Analyze captured
btnAnalyze.onclick=async()=>{
  if(!captured)return;
  btnAnalyze.disabled=true;
  
  // SIMULACI√ìN DE AN√ÅLISIS PROFESIONAL
  await simulateAnalysisDelay();

  // EJECUCI√ìN REAL
  const dets=await faceapi.detectAllFaces(canvas,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();

  // 1. Dibujar resultados en el canvas
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const img=new Image(); 
  img.src=captured; await new Promise(r=>img.onload=r);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const resized=faceapi.resizeResults(dets,{width:canvas.width,height:canvas.height});
  
  // Dibujar todo el an√°lisis en la imagen final (incluyendo expresiones)
  faceapi.draw.drawDetections(canvas,resized, {boxColor: 'var(--accent-success)', lineWidth: 3});
  faceapi.draw.drawFaceLandmarks(canvas,resized);
  faceapi.draw.drawFaceExpressions(canvas,resized, 0.05);

  // 2. Actualizar HUD y Reporte
  countEl.textContent=dets.length;
  if(!dets.length){resetHUDAnalysisError(); btnAnalyze.disabled=false; return;}

  // C√°lculo y Muestra de M√©tricas
  const symmetryScore=calcSymmetry(dets[0]);
  const beautyScore=calcBeautyScore(symmetryScore); // C√°lculo de puntuaci√≥n de belleza basado en simetr√≠a
  const simulatedNationality = simulateNationality(beautyScore); // Simulaci√≥n de Nacionalidad
  
  scoreAnimate(symmetryScore.toFixed(2));
  updateProgressColor(symmetryScore);
  updateScoreFeedback(symmetryScore);
  updateEmotionDisplay(dets[0].expressions, true);
  
  // Mostrar los resultados adicionales (Puntuaci√≥n de Belleza y Pa√≠s)
  beautyScoreEl.textContent = beautyScore.toFixed(2) + ' / 10.0';
  nationalityEl.textContent = simulatedNationality;
  beautyScoreLine.style.display = 'block';
  nationalityLine.style.display = 'block';
  progressBar.style.width='100%';

  btnAnalyze.style.display='none';
  btnRetry.disabled=false;
  btnDownload.disabled=false;
};

//=== Retry (Reanudar Webcam)
btnRetry.onclick=()=>{
  running=true; video.play();
  btnCapture.style.display='inline-block';
  btnAnalyze.style.display='none';
  btnRetry.style.display='none';
  btnDownload.style.display='none';
  btnCapture.disabled=false;
  canvas.classList.add('scanner-active'); // Reactiva la animaci√≥n
  resetHUDLive(true);
  raf=requestAnimationFrame(loop);
};

//=== Download capture
btnDownload.onclick=()=>{
  if(!captured)return;
  const a=document.createElement('a');
  const finalImage = canvas.toDataURL('image/png');
  a.href=finalImage;
  a.download='SYMMETRY_ANALYSIS_V8_REPORTE.png';
  a.click();
};

/*
=======================================================
L√ìGICA DE C√ÅLCULO Y VISUALIZACI√ìN
=======================================================
*/
function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}

//=== Calcula la Simetr√≠a (ISF) - Basado en la l√≥gica V7
function calcSymmetry(det){
  try{
    const lm=det.landmarks;
    const left=centroid(lm.getLeftEye()),right=centroid(lm.getRightEye()),nose=centroid(lm.getNose()),mouth=centroid(lm.getMouth());
    const dL=dist(left,nose),dR=dist(right,nose);
    const balance=1-Math.abs(dL-dR)/Math.max(dL,dR);
    const mouthSym=1-Math.abs(mouth.x-nose.x)/(canvas.width*0.05);
    const phi=1.618;
    const ratio=(dL+dR)/(dist(left,right)||1);
    const phiScore=1-Math.abs(ratio-phi/2)/(phi/2);
    const score=Math.max(0,Math.min(100,(balance*0.5+mouthSym*0.3+phiScore*0.2)*100));
    return score;
  }catch(e){return 0;}
}

//=== C√°lculo de Puntuaci√≥n de Belleza (0.0 a 10.0) a partir de ISF
function calcBeautyScore(isf){
    // Mapea la puntuaci√≥n ISF (0-100) a una escala de belleza (0.0-10.0)
    // El 50% de ISF es 5.0, el 100% es 10.0.
    return (isf / 100) * 10;
}

//=== Simulaci√≥n de Nacionalidad (Simulamos que un score alto se relaciona con un perfil m√°s 'com√∫n' en nuestra base de datos simulada)
function simulateNationality(beautyScore){
    const index = Math.floor(Math.random() * NATIONALITIES.length);
    let nationality = NATIONALITIES[index];
    if (beautyScore > 9.0) {
        // Un score muy alto siempre se asigna a un pa√≠s m√°s grande/central, solo por simulaci√≥n.
        nationality = 'Perfil ' + NATIONALITIES[Math.floor(Math.random() * 3)];
    }
    return nationality + ' (' + (Math.random() * 20 + 75).toFixed(1) + '% de Confianza)';
}

//=== Actualiza el feedback de Simetr√≠a
function updateScoreFeedback(score){
    let feedback = '';
    let color = '';
    if(score > 90){feedback = 'ISF √âLITE (Nivel A++): Armon√≠a y Proporci√≥n Aurea √ìptima.';color = 'var(--accent-success)';} 
    else if(score > 80){feedback = 'ISF SUPERIOR (Nivel A+): Alta Simetr√≠a. Excelente Biometr√≠a.';color = 'var(--accent-success)';} 
    else if(score > 70){feedback = 'ISF EST√ÅNDAR (Nivel B): Simetr√≠a Adecuada. Balance Promedio.';color = 'var(--accent-warning)';} 
    else {feedback = 'ISF BAJO (Nivel C): Se detectan desviaciones de la l√≠nea central.';color = 'var(--accent-error)';}
    scoreFeedbackEl.textContent = feedback;
    scoreFeedbackEl.style.color = color;
}

//=== Actualiza la visualizaci√≥n de Emociones
function updateEmotionDisplay(expressions, fullReport = false){
  const sorted=Object.entries(expressions).sort((a,b)=>b[1]-a[1]);
  const dominant = sorted[0][0];
  const dominantPercent = (sorted[0][1]*100).toFixed(1);

  exprDominantEl.textContent = `${EXPR_TRADS[dominant]} (${dominantPercent}%)`;
  
  if(fullReport){
      exprAllEl.textContent = 'DETALLE (' + sorted.length + ' M√©tricas): ' + sorted.map(e=>EXPR_TRADS[e[0]]+': '+(e[1]*100).toFixed(0)+'%').join(' | ');
  } else {
      exprAllEl.textContent = 'M√©tricas secundarias disponibles tras An√°lisis Avanzado...';
  }
}

//=== Resetea el HUD en modo Detecci√≥n en Vivo
function resetHUDLive(isRetry = false){
  scoreAnimate('‚Äî');
  progressBar.style.width='4%';
  updateProgressColor(0);
  scoreFeedbackEl.textContent = isRetry ? 'Reanudando detecci√≥n en tiempo real...' : 'Rostro no detectado. Esperando entrada biom√©trica.';
  exprDominantEl.textContent = '‚Äî';
  exprAllEl.textContent = 'M√©tricas secundarias disponibles tras An√°lisis Avanzado...';
  beautyScoreLine.style.display = 'none';
  nationalityLine.style.display = 'none';
}

//=== Resetea el HUD en caso de error de an√°lisis
function resetHUDAnalysisError(){
    scoreAnimate('E-01');
    updateProgressColor(0);
    scoreFeedbackEl.textContent='ERROR CR√çTICO: Rostro no detectado en la imagen est√°tica. Reanude.';
    exprDominantEl.textContent='‚Äî';
    exprAllEl.textContent='No hay datos biom√©tricos...';
    progressBar.style.width='10%';
    beautyScoreLine.style.display = 'none';
    nationalityLine.style.display = 'none';
}

//=== Animaci√≥n del n√∫mero de la puntuaci√≥n
function scoreAnimate(val){
  scoreEl.style.transform='scale(0.8)';
  setTimeout(()=>{
    scoreEl.textContent=val;
    scoreEl.style.transform='scale(1)';
  },160);
}

//=== Cambia el color de la barra de progreso
function updateProgressColor(score){
  let color = 'var(--accent-error)';
  if(score >= 80){color = 'var(--accent-success)';} 
  else if(score >= 65){color = 'var(--accent-warning)';}
  progressBar.style.background=color;
}

//=== SIMULACI√ìN AVANZADA
async function simulateAnalysisDelay(){
    const delay = 2500; // 2.5 segundos
    // Aqu√≠ puedes a√±adir la animaci√≥n de la barra de progreso si quieres simular un proceso m√°s largo.
    // En este caso, simplemente a√±adimos el delay para el efecto 'profesional'.
    await new Promise(r => setTimeout(r, delay));
}
</script>
</body>
</html>
