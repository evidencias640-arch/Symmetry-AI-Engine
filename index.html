<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SYMMETRY AI ENGINE PRO V10.6 ‚Äî An√°lisis Biom√©trico y Est√©tico</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /*
  =======================================================
  ESTILOS BASE Y VARIABLES (V10.6 - Animal Detection & Mobile Polish)
  =======================================================
  */
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@300;600&display=swap');
  :root{
    --ia:#00ffff;
    --ia-light:#66ffff;
    --ia-glow: 0 0 12px var(--ia), 0 0 25px rgba(0,255,255,0.7);
    --bg:#000b11;
    --muted:#a0a9b5;
    --accent-error:#ff5050;
    --accent-warning:#ffaa00;
    --accent-success:#00ffb3;
    --shadow-light: 0 0 8px var(--ia), 0 0 12px var(--ia-light);
  }

  /*
  ** 1. MOBILE FIRST - Experiencia Base **
  */
  body,html{
    margin:0;padding:0;width:100%;height:100%;background:var(--bg);
    color:#e6f9ff;font-family:Inter,Arial,sans-serif;
    will-change: transform, opacity; 
    overflow-x: hidden; 
    /* MEJORA RESPONSIVA: Altura del cuerpo al 100% del viewport */
    height: 100dvh; 
  }
  #main{
    position:relative;width:100%;
    /* MEJORA RESPONSIVA: Altura del contenedor principal al 100% del viewport */
    height:100dvh;
    overflow:hidden;
  }
  
  /*
  ** 2. C√ÅMARA y CANVAS - Correcci√≥n Espejo **
  */
  #webcam-feed{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;
    z-index: 1;
    transform: scaleX(-1); 
  }
  #capture-canvas{
    position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;
    z-index: 5; 
    box-shadow: 0 0 15px rgba(0,255,255,0.5) inset;
    border: 1px solid rgba(0,255,255,0.3);
  }
  #placeholder{
    position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.9);z-index: 10; 
    text-align:center;
  }

  /*
  ** 3. HUD (RESPONSIVO Y FIJO EN M√ìVIL) **
  */
  #results{
    position:absolute;
    top:10px; 
    left:50%;
    transform: translateX(-50%);
    background:rgba(0,0,0,0.8);
    border: 2px solid rgba(0,255,255,0.3);
    padding:10px;
    border-radius:8px;
    font-size:12px;
    z-index:25;
    backdrop-filter:blur(15px);
    box-shadow: var(--ia-glow);
    width: 95%; 
    max-width: 400px;
    box-sizing: border-box;
  }
  
  /* Indicadores de Detecci√≥n (Mensaje de Detecci√≥n y Porcentaje) */
  #detection-hud {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      text-align: center;
      color: var(--ia);
      text-shadow: var(--ia-glow);
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none; 
      width: 90%;
  }

  .detection-text {
      font-family: Orbitron, sans-serif;
      font-size: 1.5em; 
      font-weight: 800;
      margin-bottom: 5px;
      line-height: 1.2;
  }
  .detection-percent {
      font-size: 3em; 
      font-weight: 800;
      line-height: 1;
  }
  
  /* CLASE DE ERROR PARA ANIMAL */
  #detection-hud.animal-detected {
      color: var(--accent-error) !important;
      text-shadow: 0 0 10px var(--accent-error);
      opacity: 1;
      animation: flash-error 0.5s infinite alternate;
  }
  @keyframes flash-error {
      from { opacity: 1; }
      to { opacity: 0.7; }
  }


  .mobile-active #results {
      opacity: 0; 
  }
  .mobile-active #detection-hud.active {
      opacity: 1; 
  }
  
  /* Estilos internos del HUD principal (mantienen el compacto) */
  .metric-label{
    font-family: Orbitron, Inter, Arial;
    font-weight: 800;
    color: var(--ia-light);
    margin-top: 8px;
    text-shadow: 0 0 5px rgba(0,255,255,0.5);
    border-bottom: 1px solid rgba(0,255,255,0.2);
    padding-bottom: 2px;
    letter-spacing: 0.5px;
    font-size: 0.75em; 
  }
  .score-val{
    font-family:Orbitron,Inter,Arial;font-size:30px;font-weight:800;
    line-height: 1;
    margin-top: 2px;
    color: var(--ia-light);
    text-shadow: var(--ia-glow);
  }
  #report-details {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px dashed rgba(0,255,255,0.2);
  }
  .detail-line { margin-bottom: 3px; font-size: 10px; } 
  .detail-line .metric-label { font-size: 0.6em; }

  /* Animaci√≥n y Alertas */
  @keyframes pulsating-glow {
    0% { opacity: 0.6; }
    50% { opacity: 1; text-shadow: var(--ia-glow); }
    100% { opacity: 0.6; }
  }
  .processing-anim {
    color: var(--ia);
    font-weight: 800;
    animation: pulsating-glow 1.5s infinite alternate;
  }
  #critical-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    padding: 15px;
    background: var(--accent-error);
    color: #000;
    font-weight: 900;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 20px var(--accent-error);
    width: 90%;
    max-width: 300px;
  }

  /*
  ** 4. CONTROLES / BOTONES (M√ìVIL) **
  */
  #controls{
    position:absolute;
    bottom: 5px; 
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap: 5px; 
    z-index:30;
    flex-wrap:wrap;
    justify-content:center;
    width: 98%; 
    max-width: 600px;
    box-sizing: border-box;
  }
  .btn{
    flex-grow: 1;
    min-width: 100px; 
    background:rgba(0,0,0,0.8);
    border:2px solid rgba(0,255,255,0.4);
    color:var(--ia);
    padding: 10px 5px; 
    border-radius:10px;
    cursor:pointer;
    backdrop-filter:blur(10px);
    font-weight:700;
    font-family: Inter, Arial;
    letter-spacing: 0.5px;
    font-size: 11px; 
    transition: background .3s, transform .2s, box-shadow .3s, opacity 0.3s;
    will-change: transform;
    line-height: 1.1; 
    text-align: center;
  }
  .primary{
    background:linear-gradient(90deg,var(--ia),var(--ia-light));
    color:#000;
    border-color: var(--ia-light);
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Ajuste de Flexbox para que INICIAR/CAPTURAR ocupen m√°s */
  #start, #capture {
      flex-basis: 48%; 
  }
  #analyze, #retry, #download {
      flex-basis: 30%;
      min-width: unset;
  }

  /*
  =======================================================
  MEDIA QUERIES - Escritorio / Tabletas (Min-width) üíª
  =======================================================
  */
  @media(min-width:601px){
    /* Restaurar el HUD al estilo de escritorio */
    #results{
      top:10px;
      right:10px;
      left: auto;
      transform: none;
      font-size:14px;
      max-width: 380px;
      width: auto;
      opacity: 1 !important; 
    }
    #detection-hud {
        display: none; 
    }
    .mobile-active #results {
        opacity: 1 !important; 
    }

    .metric-label{
        margin-top: 10px;
        letter-spacing: 1px;
        font-size: 0.85em;
    }
    .score-val{font-size:36px;}
    .detail-line { font-size: 14px; }
    .detail-line .metric-label { font-size: 0.85em; }

    /* Restaurar Controles al estilo de escritorio */
    #controls{
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      gap:10px;
      width: 95%; 
      max-width: 600px;
    }
    .btn{
      padding:12px 16px;
      font-size: 14px;
      line-height: normal;
    }
    #start, #capture, #analyze, #retry, #download {
        flex-basis: auto;
        min-width: 120px;
    }
    #start { flex-grow: 1; }
    
    /* Restaurar el feed de la c√°mara (sin espejo) si es deseado para escritorio */
    #webcam-feed {
        transform: none; 
    }
  }
</style>
</head>
<body>
<div id="main">
  <video id="webcam-feed" autoplay muted playsinline></video>
  <canvas id="capture-canvas"></canvas>

  <div id="placeholder">
    <h2 style="color:var(--ia)">SYMMETRY AI ENGINE V10.6 ‚Äî M√ìDULO INACTIVO</h2>
    <p id="placeholder-msg" style="color:var(--muted)">Active la c√°mara y presione <strong>INICIAR DETECCI√ìN</strong>.</p>
  </div>
  
  <div id="critical-warning" style="display:none;"></div>
  
  <div id="detection-hud">
      <div class="detection-text" id="det-msg">Esperando rostro...</div>
      <div class="detection-percent" id="det-percent">‚Äî</div>
      <div id="animal-warning" style="color: var(--accent-error); font-weight: 700; margin-top: 10px; font-size: 1.2em; display: none;"></div>
  </div>

  <div id="results">
    <div><b>DETECCIONES ACTIVAS:</b> <span id="count">0</span></div>

    <div class="metric-label">√çNDICE DE SIMETR√çA FACIAL (ISF)</div>
    <div id="score" class="score-val">‚Äî</div>
    <div id="progress"><div style="width: 4%;"></div></div>
    <div id="score-feedback" style="font-size:12px; margin-top:4px;">Inicie el an√°lisis biom√©trico.</div>

    <div id="report-details">
      <div class="detail-line"><span class="metric-label" style="border:none;">PUNT. EST√âTICA (PROPORCI√ìN √ÅUREA):</span> <span id="beauty-score" class="score-val" style="font-size:16px; color: var(--accent-warning);">‚Äî</span></div>
      <div class="detail-line"><span class="metric-label" style="border:none;">EDAD APROX. (IA):</span> <span id="age-score" style="color:var(--ia-light); font-weight:600;">‚Äî</span></div>
      <div class="detail-line"><span class="metric-label" style="border:none;">ESTADO CIVIL (SIMULADO):</span> <span id="civil-status" style="color:var(--accent-error); font-weight:600);">‚Äî</span></div>
      <div class="detail-line"><span class="metric-label" style="border:none;">PA√çS DE PERFIL SUGERIDO:</span> <span id="nationality" style="color:var(--accent-warning); font-weight:600);">‚Äî</span></div>
      
      <div class="detail-line" style="margin-top: 10px;"><span class="metric-label" style="border:none;">EMOCI√ìN DOMINANTE:</span> <span id="expr-dominant" style="color:var(--ia-light); font-weight:600;">‚Äî</span></div>
      <small id="expr-all" style="display:block; margin-top: 4px; color: var(--muted); font-size: 10px;">Detalle de emociones...</small>
    </div>
  </div>

  <div id="controls">
    <button id="start" class="btn">‚ñ∂ INICIAR DETECCI√ìN</button>
    <button id="capture" class="btn primary" disabled>üì∏ CAPTURAR</button>
    <button id="analyze" class="btn" style="display:none">‚öôÔ∏è ANALIZAR PROFESIONAL</button>
    <button id="retry" class="btn" style="display:none">üîÑ REANUDAR</button>
    <button id="download" class="btn" style="display:none" disabled>‚¨áÔ∏è REPORTE</button>
  </div>
</div>

<script src="./face-api.min.js"></script>
<script>
/*
=======================================================
JAVASCRIPT/FACE-API.JS L√ìGICA (V10.6 - Final)
=======================================================
*/
const MODELS_URL='./models';
// Elementos DOM
const main = document.getElementById('main'); 
const video=document.getElementById('webcam-feed');
const canvas=document.getElementById('capture-canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const placeholder=document.getElementById('placeholder');
const placeholderMsg=document.getElementById('placeholder-msg');
const countEl=document.getElementById('count');
const scoreEl=document.getElementById('score');
const progressBar=document.querySelector('#progress>div');
const scoreFeedbackEl=document.getElementById('score-feedback');
// M√©tricas
const beautyScoreEl=document.getElementById('beauty-score');
const ageScoreEl=document.getElementById('age-score');
const civilStatusEl=document.getElementById('civil-status');
const nationalityEl=document.getElementById('nationality');
const exprDominantEl=document.getElementById('expr-dominant');
const exprAllEl=document.getElementById('expr-all');
// HUD de Detecci√≥n Inmersivo
const detectionHud = document.getElementById('detection-hud');
const detMsg = document.getElementById('det-msg');
const detPercent = document.getElementById('det-percent');
const animalWarning = document.getElementById('animal-warning'); // Nuevo

const btnStart=document.getElementById('start');
const btnCapture=document.getElementById('capture');
const btnAnalyze=document.getElementById('analyze');
const btnRetry=document.getElementById('retry');
const btnDownload=document.getElementById('download');
const criticalWarningEl = document.getElementById('critical-warning');

let running=false,raf=null,captured=null, lastDet = null, lastScore = 0;
let animalDetected = null; // Nuevo: Para almacenar si se detect√≥ un animal.

// TRADUCCIONES Y DATOS DE SIMULACI√ìN (Mantenido)
const EXPR_TRADS = {
    'neutral': 'Neutralidad', 'happy': 'Satisfacci√≥n', 'sad': 'Melancol√≠a',
    'angry': 'Ira', 'fearful': 'Temor', 'disgusted': 'Disgusto', 'surprised': 'Sorpresa'
};
const NATIONALITIES = ['Espa√±a', 'M√©xico', 'Colombia', 'Argentina', 'Chile', 'Per√∫', 'Venezuela'];
const CIVIL_STATUS = ['Soltero/a', 'En Relaci√≥n (Pareja)', 'Casado/a (Compromiso)'];

// SIMULACI√ìN DE DETECCI√ìN DE ANIMALES
const ANIMAL_CLASSES = ['Perro', 'Gato', 'P√°jaro', 'Vaca', 'Caballo'];
function checkAnimalDetection(detections) {
    if (detections.length === 0) return null; // No hay detecciones faciales

    // L√≥gica de Simulaci√≥n: Hay una probabilidad de que la IA 'detecte' un animal
    // si no hay un rostro humano claro, o por un breve instante.
    if (Math.random() < 0.05) { // 5% de probabilidad de detectar un animal
        const animal = ANIMAL_CLASSES[Math.floor(Math.random() * ANIMAL_CLASSES.length)];
        return animal;
    }
    return null; 
}


//=== Init models 
async function loadModels(){
  btnStart.textContent = 'Cargando IA...';
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL),
    faceapi.nets.ageGenderNet.loadFromUri(MODELS_URL) 
  ]);
  btnStart.textContent = '‚ñ∂ INICIAR DETECCI√ìN';
  btnStart.disabled=false;
}
window.addEventListener('load',loadModels);

//=== Start camera
btnStart.onclick=async()=>{
  try{
    placeholderMsg.textContent = 'Solicitando permiso de c√°mara al sistema...';
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream; await video.play();
    placeholder.style.display='none';
    btnStart.style.display='none'; 
    btnCapture.style.display='inline-block';
    btnAnalyze.style.display='none'; 
    btnRetry.style.display='none'; 
    btnDownload.style.display='none';
    btnCapture.disabled=false;
    resizeCanvas(); running=true; loop();
    canvas.classList.add('scanner-active');
    main.classList.add('mobile-active'); 
    resetHUDLive();
  }catch(e){
    placeholderMsg.textContent = 'ERROR C√ÅMARA: No se pudo acceder. Vuelva a intentar o revise los permisos.';
    showWarning('ERROR C√ÅMARA: No se pudo acceder. Aseg√∫rese de tener permisos.');
  }
};

//=== Resize canvas (Mantenido)
function resizeCanvas(){
  const displaySize = { width: video.clientWidth, height: video.clientHeight };
  faceapi.matchDimensions(canvas, displaySize);
}
window.addEventListener('resize',resizeCanvas);
video.addEventListener('play', resizeCanvas);


//=== Live detection loop 
async function loop(){
  if(!running)return;
  const displaySize = { width: canvas.width, height: canvas.height };
  
  const det=await faceapi.detectAllFaces(video,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();
  
  const resized=faceapi.resizeResults(det, displaySize);
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  faceapi.draw.drawFaceLandmarks(canvas,resized);

  // >>> NUEVA L√ìGICA DE DETECCI√ìN DE ANIMALES Y CONTROL <<<
  animalDetected = checkAnimalDetection(det); 

  if (animalDetected) {
      // Bloquear todo si se detecta un animal
      animalWarning.textContent = `¬°ALERTA DE OBJETO!: ${animalDetected}. AN√ÅLISIS EXCLUSIVO PARA SERES HUMANOS.`;
      animalWarning.style.display = 'block';
      detectionHud.classList.add('animal-detected');
      btnCapture.disabled = true;
      lastDet = null;
      countEl.textContent = '0 (ANIMAL)';
      detMsg.textContent = 'AN√ÅLISIS BLOQUEADO';
      detPercent.textContent = 'ERROR';
      resetHUDLive();
      
  } else if(det.length > 0){
      // Rostro humano detectado - Flujo normal
      animalWarning.style.display = 'none';
      detectionHud.classList.remove('animal-detected');
      btnCapture.disabled = false;
      
      lastDet = det[0];
      const score=calcSymmetry(lastDet);
      lastScore = score;
      scoreAnimate(score.toFixed(2));
      updateProgressColor(score);
      updateEmotionDisplay(lastDet.expressions, false);
      scoreFeedbackEl.textContent = 'ROSTRO DETECTADO. Detecci√≥n Bi-Dimensional Activa.';
      progressBar.style.width='30%';
      beautyScoreEl.textContent = score.toFixed(2) + '%';
      ageScoreEl.textContent = 'Procesando...'; 
      
      // ACTUALIZAR HUD DE DETECCI√ìN INMERSIVO
      detectionHud.classList.add('active');
      detMsg.textContent = 'ROSTRO EN FOCO. Porcentaje de Detecci√≥n:';
      detPercent.textContent = `${(lastDet.detection.score * 100).toFixed(0)}%`;

  } else {
    // No hay detecciones (ni rostros ni animales)
    animalWarning.style.display = 'none';
    detectionHud.classList.remove('animal-detected');
    lastDet = null;
    btnCapture.disabled = true;
    resetHUDLive();
    
    // OCULTAR/RESETEAR HUD DE DETECCI√ìN INMERSIVO
    detectionHud.classList.remove('active');
    detMsg.textContent = 'Esperando rostro...';
    detPercent.textContent = '‚Äî';
  }

  raf=requestAnimationFrame(loop);
}

//=== Capture image 
btnCapture.onclick=()=>{
  if(parseInt(countEl.textContent) === 0 || !lastDet){
    showWarning('‚ö†Ô∏è ERROR CR√çTICO: ROSTRO NO RECONOCIDO. POSICI√ìNESE FRENTE AL SENSOR.'); 
    return;
  }
  // Bloqueo adicional por si acaso el animal fue detectado antes de la captura
  if (animalDetected) {
      showWarning(`AN√ÅLISIS BLOQUEADO: Se detect√≥ un ${animalDetected}. El an√°lisis es solo para humanos.`);
      return;
  }

  running=false; cancelAnimationFrame(raf); video.pause();
  
  // 1. Redimensionar el canvas a las dimensiones nativas del video para la mejor calidad de descarga
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = video.videoWidth;
  tempCanvas.height = video.videoHeight;
  const tempCtx = tempCanvas.getContext('2d');
  
  // 2. Dibujar el video SIN el efecto espejo (para la imagen final)
  tempCtx.save();
  tempCtx.scale(-1, 1); 
  tempCtx.drawImage(video, -tempCanvas.width, 0, tempCanvas.width, tempCanvas.height);
  tempCtx.restore();
  
  // 3. Dibujar las detecciones (landMarks) sobre el video no espejado
  if (lastDet) {
      const resizedForDownload = faceapi.resizeResults([lastDet], { width: tempCanvas.width, height: tempCanvas.height });

      // Opcional: Dibujar las l√≠neas gu√≠as sim√©tricas
      tempCtx.strokeStyle = 'rgba(0,255,255, 0.7)';
      tempCtx.lineWidth = 2;
      
      // Dibujar l√≠neas de referencia (ejemplo: l√≠nea central)
      const centerX = tempCanvas.width / 2;
      tempCtx.beginPath();
      tempCtx.moveTo(centerX, 0);
      tempCtx.lineTo(centerX, tempCanvas.height);
      tempCtx.stroke();
      
      // Dibujar las marcas faciales
      faceapi.draw.drawFaceLandmarks(tempCanvas, resizedForDownload);
  }
  
  // Guardar la imagen de alta resoluci√≥n para la descarga
  captured=tempCanvas.toDataURL('image/png');
  
  // Volver a dibujar el canvas de visualizaci√≥n (low-res) con la imagen capturada para que el usuario la vea
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const img=new Image(); 
  img.src=captured; 
  img.onload = () => {
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  };
  
  main.classList.remove('mobile-active'); 
  detectionHud.classList.remove('active'); 
  animalWarning.style.display = 'none'; // Asegurar que se oculte

  btnCapture.style.display='none';
  btnAnalyze.style.display='inline-block';
  btnRetry.style.display='inline-block';
  btnDownload.style.display='none';
  btnAnalyze.disabled=false;
  btnDownload.disabled=true;
  scoreFeedbackEl.textContent = 'IMAGEN CONGELADA. Listo para An√°lisis Profesional.';
  progressBar.style.width='5%';
};

//=== Analyze captured (Mantenido)
btnAnalyze.onclick=async()=>{
  if(!captured)return;
  btnAnalyze.disabled=true;
  
  // Animaci√≥n de Carga
  scoreFeedbackEl.innerHTML = '<span class="processing-anim">ANALIZANDO DATOS BIOM√âTRICOS... ESPERE.</span>';
  ageScoreEl.textContent = 'Calculando...';
  civilStatusEl.textContent = 'Calculando...';
  nationalityEl.textContent = 'Calculando...';
  exprDominantEl.textContent = 'Calculando...';
  progressBar.style.width='50%'; 

  await simulateAnalysisDelay();
  
  // El an√°lisis se hace sobre la imagen capturada (captured) para garantizar la consistencia
  const img=new Image(); 
  img.src=captured; await new Promise(r=>img.onload=r);
  
  const dets=await faceapi.detectAllFaces(img,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions().withAgeAndGender();
  
  // Limpiar el canvas visible
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Dibujar la imagen de alta resoluci√≥n en el canvas de visualizaci√≥n (resized)
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  const resized=faceapi.resizeResults(dets,{width:canvas.width,height:canvas.height});
  
  // DIBUJAR LOS RESULTADOS DEL AN√ÅLISIS EN EL CANVAS VISIBLE
  faceapi.draw.drawDetections(canvas,resized, {boxColor: 'var(--accent-success)', lineWidth: 3});
  faceapi.draw.drawFaceLandmarks(canvas,resized);
  faceapi.draw.drawFaceExpressions(canvas,resized, 0.05);

  countEl.textContent=dets.length;
  if(!dets.length){resetHUDAnalysisError(); btnAnalyze.disabled=false; return;}

  const finalDet = dets[0];
  const symmetryScore=calcSymmetry(finalDet);
  const beautyScoreNumber=calcBeautyScore(symmetryScore);
  const simulatedNationality = simulateNationality(beautyScoreNumber);
  const simulatedCivilStatus = simulateCivilStatus(finalDet.expressions);
  
  scoreAnimate(symmetryScore.toFixed(2));
  updateProgressColor(symmetryScore);
  updateScoreFeedback(symmetryScore);
  
  beautyScoreEl.textContent = beautyScoreNumber.toFixed(2) + '%';
  ageScoreEl.textContent = `${Math.round(finalDet.age)} a√±os (G√©nero: ${finalDet.gender === 'male' ? 'Masc.' : 'Fem.'})`;
  civilStatusEl.textContent = simulatedCivilStatus;
  nationalityEl.textContent = simulatedNationality;
  updateEmotionDisplay(finalDet.expressions, true);
  
  progressBar.style.width='100%';

  // REGENERAR LA IMAGEN DE DESCARGA CON LOS DIBUJOS DEL AN√ÅLISIS Y OVERLAY
  const finalDownloadCanvas = document.createElement('canvas');
  finalDownloadCanvas.width = img.width;
  finalDownloadCanvas.height = img.height;
  const finalDownloadCtx = finalDownloadCanvas.getContext('2d');
  
  // 1. Dibujar la imagen base capturada (que ya no tiene espejo)
  finalDownloadCtx.drawImage(img, 0, 0, img.width, img.height);

  // 2. Dibujar las detecciones redimensionadas a la resoluci√≥n de descarga
  const resizedForFinalDownload = faceapi.resizeResults(dets,{width: finalDownloadCanvas.width, height: finalDownloadCanvas.height});
  faceapi.draw.drawDetections(finalDownloadCanvas,resizedForFinalDownload, {boxColor: 'var(--accent-success)', lineWidth: 4});
  faceapi.draw.drawFaceLandmarks(finalDownloadCanvas,resizedForFinalDownload);
  
  // 3. Dibujar el overlay de resultados (la tabla) en el canvas de descarga
  drawReportOverlay(finalDownloadCanvas, finalDet, symmetryScore, beautyScoreNumber, simulatedNationality, simulatedCivilStatus);
  
  captured=finalDownloadCanvas.toDataURL('image/png'); // Sobreescribir la imagen capturada con el reporte final

  btnAnalyze.style.display='none';
  btnRetry.style.display='inline-block';
  btnDownload.style.display='inline-block';
  btnRetry.disabled=false;
  btnDownload.disabled=false;
};

//=== Retry (Mantenido)
btnRetry.onclick=()=>{
  running=true; video.play();
  btnCapture.style.display='inline-block';
  btnAnalyze.style.display='none';
  btnRetry.style.display='none';
  btnDownload.style.display='none';
  btnCapture.disabled=false;
  btnDownload.disabled=true;
  canvas.classList.add('scanner-active');
  main.classList.add('mobile-active'); 
  resetHUDLive(true);
  raf=requestAnimationFrame(loop);
};

//=== Download capture (Mantenido)
btnDownload.onclick=()=>{
  if(!captured)return;
  const a=document.createElement('a');
  a.href=captured;
  a.download='SYMMETRY_ANALYSIS_V10.6_REPORTE.png';
  a.click();
};

/*
=======================================================
L√ìGICA DE C√ÅLCULO Y SIMULACI√ìN (HELPERS)
=======================================================
*/

// Las siguientes funciones se mantienen del c√≥digo anterior...

function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}

function calcSymmetry(det){
  try{
    const lm=det.landmarks;
    const left=centroid(lm.getLeftEye()),right=centroid(lm.getRightEye()),nose=centroid(lm.getNose()),mouth=centroid(lm.getMouth());
    const dL=dist(left,nose),dR=dist(right,nose);
    const balance=1-Math.abs(dL-dR)/Math.max(dL,dR);
    const mouthSym=1-Math.abs(mouth.x-nose.x)/(canvas.width*0.05);
    const phi=1.618;
    const ratio=(dL+dR)/(dist(left,right)||1);
    const phiScore=1-Math.abs(ratio-ratio/phi)/(ratio/phi);
    const score=Math.max(0,Math.min(100,(balance*0.5+mouthSym*0.3+phiScore*0.2)*100));
    return score;
  }catch(e){return 0;}
}

function calcBeautyScore(isf){return isf;} 
function simulateNationality(beautyScore){
    const index = Math.floor(Math.random() * NATIONALITIES.length);
    let nationality = NATIONALITIES[index];
    if (beautyScore > 90) {
        nationality = 'Perfil ' + NATIONALITIES[Math.floor(Math.random() * 3)];
    }
    return nationality + ' (' + (Math.random() * 20 + 75).toFixed(1) + '% Confianza)';
}
function simulateCivilStatus(expressions){
    const dominant = Object.entries(expressions).sort((a,b)=>b[1]-a[1])[0][0];
    let status = CIVIL_STATUS[0]; 
    if (dominant === 'happy' || dominant === 'neutral') {
        const rand = Math.random();
        if (rand < 0.4) status = CIVIL_STATUS[1]; 
        else if (rand < 0.7) status = CIVIL_STATUS[2];
    }
    return status;
}

function updateScoreFeedback(score){
    let feedback = '';
    let color = '';
    if(score > 90){feedback = 'ISF √âLITE (A++): Armon√≠a y Proporci√≥n √Åurea √ìptima.';color = 'var(--accent-success)';} 
    else if(score > 80){feedback = 'ISF SUPERIOR (A+): Alta Simetr√≠a. Excelente Biometr√≠a.';color = 'var(--accent-success)';} 
    else if(score > 70){feedback = 'ISF EST√ÅNDAR (B): Simetr√≠a Adecuada. Balance Promedio.';color = 'var(--accent-warning)';} 
    else {feedback = 'ISF BAJO (C): Se detectan desviaciones de la l√≠nea central.';color = 'var(--accent-error)';}
    scoreFeedbackEl.textContent = feedback;
    scoreFeedbackEl.style.color = color;
}
function updateEmotionDisplay(expressions, fullReport = false){
  const sorted=Object.entries(expressions).sort((a,b)=>b[1]-a[1]);
  const dominant = sorted[0][0];
  const dominantPercent = (sorted[0][1]*100).toFixed(1);
  exprDominantEl.textContent = `${EXPR_TRADS[dominant]} (${dominantPercent}%)`;
  if(fullReport){
      exprAllEl.textContent = 'DETALLE (' + sorted.length + ' M√©tricas): ' + sorted.map(e=>EXPR_TRADS[e[0]]+': '+(e[1]*100).toFixed(0)+'%').join(' | ');
  } else {
      exprAllEl.textContent = 'Detalle de emociones disponible tras An√°lisis Profesional...';
  }
}
function resetHUDLive(isRetry = false){
  scoreAnimate('‚Äî');
  progressBar.style.width='4%';
  updateProgressColor(0);
  scoreFeedbackEl.textContent = isRetry ? 'Reanudando detecci√≥n en tiempo real...' : 'Rostro no detectado. Esperando entrada biom√©trica.';
  exprDominantEl.textContent = '‚Äî';
  exprAllEl.textContent = 'Detalle de emociones disponible tras An√°lisis Profesional...';
  beautyScoreEl.textContent = '‚Äî';
  ageScoreEl.textContent = '‚Äî';
  civilStatusEl.textContent = '‚Äî';
  nationalityEl.textContent = '‚Äî';
  countEl.textContent = '0';
}
function resetHUDAnalysisError(){
    scoreAnimate('E-01');
    updateProgressColor(0);
    scoreFeedbackEl.textContent='ERROR CR√çTICO: Rostro no detectado en la imagen est√°tica. Reanude.';
    exprDominantEl.textContent='‚Äî';
    exprAllEl.textContent='No hay datos biom√©tricos...';
    progressBar.style.width='10%';
    beautyScoreEl.textContent = '‚Äî';
    ageScoreEl.textContent = '‚Äî';
    civilStatusEl.textContent = '‚Äî';
    nationalityEl.textContent = '‚Äî';
}
function scoreAnimate(val){
  scoreEl.style.transform='scale(0.8)';
  setTimeout(()=>{
    scoreEl.textContent=val;
    scoreEl.style.transform='scale(1)';
  },160);
}
function updateProgressColor(score){
  let color = 'var(--accent-error)';
  if(score >= 80){color = 'var(--accent-success)';} 
  else if(score >= 65){color = 'var(--accent-warning)';}
  progressBar.style.background=color;
}
async function simulateAnalysisDelay(){
    const delay = 3000;
    await new Promise(r => setTimeout(r, delay));
}
// Funci√≥n para dibujar el reporte (Mantenido)
function drawReportOverlay(canvas, det, isf, beauty, nationality, civilStatus) {
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // √Årea de la tabla de resultados (esquina superior derecha, estilo futurista)
    const reportWidth = Math.min(width * 0.45, 450); 
    const padding = 20;
    const x = width - reportWidth - padding;
    const y = padding;
    const headerHeight = 40;
    
    // Fondo semi-transparente
    ctx.fillStyle = 'rgba(0, 11, 17, 0.85)'; 
    ctx.fillRect(x, y, reportWidth, 300);
    
    // Borde de ne√≥n
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.7)'; 
    ctx.lineWidth = 2;
    ctx.shadowBlur = 10;
    ctx.shadowColor = 'rgba(0, 255, 255, 0.5)';
    ctx.strokeRect(x, y, reportWidth, 300);
    ctx.shadowBlur = 0;

    // T√≠tulo
    ctx.fillStyle = 'var(--ia-light)';
    ctx.font = 'bold 18px Orbitron';
    ctx.textAlign = 'center';
    ctx.fillText('AN√ÅLISIS BIOM√âTRICO (V10.6)', x + reportWidth / 2, y + 25);
    
    // Separador
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.3)';
    ctx.beginPath();
    ctx.moveTo(x + 10, y + headerHeight);
    ctx.lineTo(x + reportWidth - 10, y + headerHeight);
    ctx.stroke();

    // Contenido (M√©tricas)
    ctx.textAlign = 'left';
    let lineY = y + headerHeight + 15;
    const lineSpacing = 30;
    
    const drawMetric = (label, value, color) => {
        ctx.fillStyle = 'var(--ia-light)';
        ctx.font = '14px Inter';
        ctx.fillText(label, x + 15, lineY);
        
        ctx.fillStyle = color;
        ctx.font = 'bold 16px Orbitron';
        ctx.textAlign = 'right';
        ctx.fillText(value, x + reportWidth - 15, lineY);
        
        lineY += lineSpacing;
        ctx.textAlign = 'left';
    };

    // Datos
    drawMetric('√çNDICE DE SIMETR√çA FACIAL (ISF):', isf.toFixed(2) + '%', isf > 80 ? 'var(--accent-success)' : 'var(--accent-warning)');
    drawMetric('PUNTUACI√ìN EST√âTICA (√ÅUREA):', beauty.toFixed(2) + '%', 'var(--accent-warning)');
    drawMetric('EDAD APROXIMADA (IA):', `${Math.round(det.age)} a√±os`, 'var(--ia-light)');
    drawMetric('G√âNERO PREDICTIVO:', det.gender === 'male' ? 'MASCULINO' : 'FEMENINO', 'var(--ia-light)');
    
    lineY += lineSpacing / 2;
    
    drawMetric('PA√çS DE PERFIL SUGERIDO:', nationality.split('(')[0].trim(), 'var(--accent-warning)');
    drawMetric('ESTADO CIVIL (SIMULADO):', civilStatus, 'var(--accent-error)');

    // Emoci√≥n Dominante
    const sorted=Object.entries(det.expressions).sort((a,b)=>b[1]-a[1]);
    const dominantName = EXPR_TRADS[sorted[0][0]];
    const dominantPercent = (sorted[0][1]*100).toFixed(1);
    
    lineY += lineSpacing / 2;
    drawMetric('EMOCI√ìN DOMINANTE:', `${dominantName} (${dominantPercent}%)`, 'var(--ia-light)');

    // Firma del Motor
    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    ctx.fillText('SYMMETRY AI ENGINE V10.6 - REPORT GENERATED', x + reportWidth - 5, y + 290);
}

// ... fin de las funciones JavaScript

</script>
</body>
</html>
