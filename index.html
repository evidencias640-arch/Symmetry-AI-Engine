<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SYMMETRY AI ENGINE PRO V13.1 ‚Äî Professional Biometric Analysis System</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /*
  =======================================================
  ESTILOS BASE Y VARIABLES (V13.1 - M√ÅXIMA RESPONSIVIDAD)
  =======================================================
  */
  @import url('https://fonts.com/css2?family=Orbitron:wght@600;800&family=Inter:wght@300;600;700&display=swap');
  :root{
    --ia:#00ffff; /* Cian principal */
    --ia-light:#66ffff;
    --ia-glow: 0 0 10px var(--ia), 0 0 20px rgba(0,255,255,0.7);
    --bg:#000b11;
    --panel-bg: rgba(5, 15, 25, 0.95); 
    --muted:#a0a9b5;
    --accent-error:#ff5050;
    --accent-warning:#ffaa00;
    --accent-success:#00ffb3;
    --nav-width: 80px; /* Ancho fijo de la navegaci√≥n profesional */
    --panel-width: 340px; /* Ancho fijo del panel de m√©tricas en escritorio */
  }

  /* ESTRUCTURA GENERAL Y SPA */
  body,html{
    margin:0;padding:0;width:100%;height:100%;background:var(--bg);
    color:#e6f9ff;font-family:Inter,Arial,sans-serif;
    overflow:hidden; 
    height: 100dvh; /* Para mejor manejo de la altura en m√≥viles */
  }
  #main{
    position:relative;
    display: flex;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  /* BARRA DE NAVEGACI√ìN LATERAL (Solo Escritorio/Tablet) */
  #nav-sidebar {
    width: var(--nav-width);
    background: #011523;
    box-shadow: 2px 0 8px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 20px;
    z-index: 50;
    flex-shrink: 0;
  }
  .nav-item {
      cursor: pointer; padding: 10px 5px; margin-bottom: 10px; text-align: center;
      color: var(--muted); font-size: 10px; transition: color 0.3s;
  }
  .nav-item:hover, .nav-item.active { color: var(--ia-light); text-shadow: 0 0 5px var(--ia); }
  .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }


  /* VISTAS SPA */
  .view {
    position: absolute;
    top: 0; left: var(--nav-width);
    width: calc(100% - var(--nav-width));
    height: 100%;
    display: none; 
    transition: opacity 0.5s;
    flex-direction: column; 
    align-items: stretch;
  }
  .view.active { display: flex; z-index: 10; }
  
  /* =======================================================
  LIVE SCAN VIEW (CSS GRID RESPONSIVO)
  =======================================================
  */
  #live-scan-view {
      padding: 0;
      /* Desktop Grid Layout: C√°mara (1fr) | Metrics (Fijo) */
      display: grid;
      grid-template-columns: 1fr var(--panel-width); 
      grid-template-areas: "camera metrics";
      overflow: hidden;
  }
  #scan-container {
    grid-area: camera;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.5); 
  }
  #metrics-panel{
    grid-area: metrics;
    width: var(--panel-width);
    background: var(--panel-bg); 
    padding: 25px;
    backdrop-filter: blur(10px);
    box-shadow: -5px 0 20px rgba(0,0,0,0.7);
    overflow-y: auto;
    flex-shrink: 0;
  }

  /* Elementos de la C√°mara y Botones */
  #webcam-feed, #capture-canvas { position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover; z-index: 1; }
  #capture-canvas { z-index: 5; box-shadow: var(--ia-glow) inset; border: 2px solid rgba(0,255,255,0.4); }
  
  #action-button-container {
      position: absolute; /* Usamos 'absolute' en escritorio, 'sticky' en m√≥vil */
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 400px;
      z-index: 51; 
  }
  .btn{
    width: 100%; padding: 15px 20px; border-radius: 10px; cursor: pointer;
    background:rgba(0,0,0,0.8); border:2px solid rgba(0,255,255,0.4);
    color:var(--ia); font-weight:700; font-family: Orbitron, Inter; font-size: 16px;
    transition: background .3s, transform .2s, box-shadow .3s, opacity 0.3s;
  }
  .btn.primary { background: var(--ia-light); color: #000; border-color: var(--ia-light); box-shadow: var(--ia-glow); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Estilos de las M√©tricas */
  .score-val{ font-family:Orbitron, sans-serif;font-size:36px;font-weight:800; color: var(--ia-light); text-shadow: var(--ia-glow);}
  .metric-label{ font-weight: 700; color: var(--muted); font-size: 0.95em; margin-bottom: 5px; text-transform: uppercase; }
  .detail-line span { font-size: 14px; font-weight: 600; }
  .metric-block { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed rgba(0,255,255,0.2); }

  /* Progress Bar */
  #progress-bar-container {
    position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
    width: 80%; max-width: 400px; background: rgba(0,0,0,0.8); border: 1px solid var(--ia);
    border-radius: 5px; overflow: hidden; height: 25px; z-index: 51; display: none;
  }
  #progress-bar { height: 100%; width: 0%; background: var(--ia); transition: width 0.5s; }
  #progress-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #000; font-size: 10px; font-weight: 700; text-shadow: none; z-index: 10; }

  /* =======================================================
  MEDIA QUERIES (RESPONSIVIDAD TOTAL V13.1) üì±
  =======================================================
  */
  @media(max-width:1024px){
      /* Tablet Vertical y M√≥vil */
      #main { flex-direction: column; }
      #nav-sidebar { display: none; } /* Ocultamos la navegaci√≥n lateral para m√≥vil/tablet */
      
      .view { left: 0; width: 100%; } 
      
      #live-scan-view {
          /* Apilado: C√°mara arriba (1fr), M√©tricas abajo (auto) */
          grid-template-columns: 1fr;
          grid-template-rows: 1fr auto; 
          grid-template-areas: "camera" "metrics";
          overflow-y: auto; 
      }
      #metrics-panel {
          width: 100%;
          min-height: 400px; /* Asegura espacio para todas las m√©tricas */
          box-shadow: 0 -5px 20px rgba(0,0,0,0.7);
          padding: 15px;
      }
      
      /* Reubicaci√≥n de Controles a 'sticky' en el √°rea de la c√°mara para que floten */
      #action-button-container {
          position: sticky; 
          bottom: 10px; 
          width: 90%;
          max-width: 90%;
          margin: 0 auto;
          left: 0;
          transform: none;
          display: flex;
          gap: 5px;
          flex-wrap: wrap; 
          justify-content: center;
      }
      .btn {
          padding: 8px 10px;
          font-size: 12px; 
          flex-grow: 1;
          min-width: 100px;
      }
      #progress-bar-container {
          bottom: 60px; /* Subimos la barra de progreso */
      }
      
      /* Ajuste de vistas gen√©ricas en m√≥vil */
      .generic-view-content { padding: 15px; }
      .generic-view-content h1 { font-size: 2em; margin-bottom: 20px; }
      .tech-card { padding: 15px; }
  }

  /* =======================================================
  ESTILOS GEN√âRICOS DE VISTAS (SPA)
  =======================================================
  */
  .generic-view-content {
      flex-grow: 1; padding: 40px; text-align: left; overflow-y: auto;
  }
  .generic-view-content h1 {
      font-family: Orbitron, sans-serif; font-size: 2.5em; color: var(--ia-light);
      margin-bottom: 30px; text-shadow: var(--ia-glow); border-bottom: 1px solid var(--ia); padding-bottom: 10px;
  }
  .tech-card {
      background: rgba(0, 255, 255, 0.05); border: 1px solid var(--ia); padding: 20px;
      border-radius: 8px; margin-bottom: 20px; box-shadow: 0 0 5px var(--ia); transition: transform 0.3s;
  }
  .tech-card h3 {
      font-family: Inter, sans-serif; font-size: 1.3em; font-weight: 700; color: var(--ia-light); margin-bottom: 10px;
  }
  #position-feedback {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%); padding: 8px 15px; 
      background: rgba(0, 0, 0, 0.7); border-radius: 5px; color: var(--ia); font-weight: 700; z-index: 20; 
      opacity: 0; transition: opacity 0.5s; font-size: 14px; text-shadow: var(--ia-glow); display:none;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<div id="main">
    
  <div id="nav-sidebar">
      <h1 style="font-family:Orbitron; font-size:16px; margin-bottom:30px; color:var(--ia)">SIMETR√çA</h1>
      <div class="nav-item active" data-view="live-scan-view">
          <i class="fas fa-camera"></i> LIVE SCAN
      </div>
      <div class="nav-item" data-view="data-analytics-view">
          <i class="fas fa-chart-line"></i> DATA ANALYTICS
      </div>
      <div class="nav-item" data-view="projects-view">
          <i class="fas fa-project-diagram"></i> PROJECTS
      </div>
      <div class="nav-item" data-view="settings-view">
          <i class="fas fa-cog"></i> SETTINGS
      </div>
      <div class="nav-item" data-view="account-view" style="margin-top: auto;">
          <i class="fas fa-user-circle"></i> ACCOUNT
      </div>
  </div>

  <div id="live-scan-view" class="view active">
      
      <div id="scan-container">
          <video id="webcam-feed" autoplay muted playsinline></video>
          <canvas id="capture-canvas"></canvas>

          <div id="placeholder">
            <h2 style="color:var(--ia); font-family:Orbitron;">SYMMETRY AI ENGINE V13.1 ‚Äî OFFLINE</h2>
            <p id="placeholder-msg" style="color:var(--muted)">Active la c√°mara y presione <strong>INICIAR ESCANEO DE SESI√ìN</strong>.</p>
          </div>
          
          <div id="position-feedback" style="display:none;"></div>
          
          <div class="scanning-text" id="scanning-status" style="display:none; position: absolute; top: 40%; left: 50%; transform: translateX(-50%); color: var(--ia); font-weight: 700; z-index: 20;">[Processing ‚Üí Locating ‚Üí Analyzing...]</div>

          <div id="action-button-container">
              <button id="main-action-btn" class="btn" disabled>‚ñ∂ INICIAR ESCANEO</button>
          </div>
          
          <div id="progress-bar-container">
              <div id="progress-bar"><span id="progress-message"></span></div>
          </div>
      </div>

      <div id="metrics-panel">
        <h3 style="font-family:Orbitron; font-size:18px; margin-bottom:15px; border-bottom: 2px solid var(--ia); padding-bottom:5px;">AN√ÅLISIS BIOM√âTRICO EN TIEMPO REAL</h3>

        <div class="metric-block">
            <div class="metric-label">√çNDICE DE SIMETR√çA FACIAL (ISF)</div>
            <div id="isf-score" class="score-val">‚Äî</div>
            <small id="isf-feedback" style="color:var(--muted); font-size:10px;">Esperando detecci√≥n de estructura primaria...</small>
            <div id="deviation-bar" style="height:12px; background:rgba(255,255,255,0.1); margin-top:8px; position:relative; overflow:hidden; border-radius: 5px;">
                <div id="dev-left" style="position:absolute; left:0; height:100%; width: 50%; background: var(--ia-light); opacity: 0.8; transition: width 0.5s;"></div>
                <div id="dev-right" style="position:absolute; right:0; height:100%; width: 50%; background: var(--accent-error); opacity: 0.8; transition: width 0.5s;"></div>
            </div>
            <small style="color:var(--ia-light); font-size:10px; display:block; margin-top:3px;">Desviaci√≥n Lateral (Izquierda/Derecha)</small>
        </div>
        
        <div class="metric-block">
            <div class="metric-label">√çNDICE DE PROPORCI√ìN BI-M√âTRICA (IPB)</div>
            <div id="beauty-score" class="score-val" style="color:var(--accent-warning); text-shadow: none; font-size: 28px;">‚Äî</div>
            <small style="color:var(--ia-light); font-size:10px;">Evaluaci√≥n basada en 38 puntos de referencia $\phi$ (Golden Ratio).</small>
            <canvas id="aurea-donut" width="100" height="100" style="float:right; margin-top:-30px;"></canvas>
        </div>
        
        <div id="report-details" class="metric-block">
            <div class="metric-label">AN√ÅLISIS PREDICTIVO (POST-CAPTURA)</div>
            <div class="detail-line"><span style="color:var(--ia);">EDAD ESTIMADA/G√âNERO (IA):</span> <span id="age-score" style="color:var(--ia-light); font-weight:700;">‚Äî</span></div>
            <div class="detail-line"><span style="color:var(--ia);">PERFIL DE CORRELACI√ìN:</span> <span id="civil-status" style="color:var(--accent-error); font-weight:700;">‚Äî</span></div>
            <div class="detail-line"><span style="color:var(--ia);">ORIGEN REGIONAL SUGERIDO:</span> <span id="nationality" style="color:var(--accent-warning); font-weight:700;">‚Äî</span></div>
            <small style="color:var(--muted); font-size:10px; display:block; margin-top:5px;">An√°lisis de patrones de datos faciales (DFA) con 99.8% de confianza.</small>
        </div>
        
        <div class="metric-block">
          <div class="metric-label">AN√ÅLISIS DE ESTADO EMOCIONAL (AEE)</div>
          <div id="expr-dominant" class="score-val" style="font-size:24px; color:var(--ia-light); text-shadow: none;">‚Äî</div>
          <small id="expr-all" style="display:block; color: var(--muted); font-size: 10px;">Procesando espectro emocional...</small>
        </div>
        
        <div class="metric-block" style="border-bottom: none;">
          <div class="metric-label">CALIDAD DE ESCANEO / CONFIANZA DEL MOTOR</div>
          <div id="confidence" class="score-val" style="font-size:22px; color:var(--accent-success); text-shadow: 0 0 10px var(--accent-success);">99.8%</div>
        </div>
      </div>
  </div>
  
  <div id="data-analytics-view" class="view">
      <div class="generic-view-content">
          <h1>DATA ANALYTICS: REPORTES BIOM√âTRICOS</h1>
          <p class="text-lg text-white mb-5">Plataforma para la visualizaci√≥n, comparaci√≥n y exportaci√≥n de reportes de escaneo profesional. Cada captura genera un registro de 100+ puntos de datos.</p>
          <div class="tech-card">
              <h3><i class="fas fa-file-pdf"></i> Reporte Profesional (PDF)</h3>
              <p class="text-sm text-gray-400">Generaci√≥n de documentos PDF detallados que incluyen la malla facial, puntuaciones ISF, IPB, y la nube de tags emocional. Integraci√≥n con sistemas de gesti√≥n de datos (DMS).</p>
          </div>
          <div class="tech-card">
              <h3><i class="fas fa-chart-bar"></i> Comparativa de Sesiones</h3>
              <p class="text-sm text-gray-400">Capacidad para superponer mallas faciales hist√≥ricas y evaluar el cambio en el ISF e IPB a lo largo de m√∫ltiples sesiones de an√°lisis.</p>
          </div>
      </div>
  </div>

  <div id="projects-view" class="view">
      <div class="generic-view-content">
          <h1>PROJECTS: ARQUITECTURA T√âCNICA Y MODELOS IA</h1>
          <p class="text-lg text-white mb-5">Detalles de las tecnolog√≠as y los modelos de Deep Learning que impulsan el motor de Simetr√≠a.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="tech-card">
                  <h3><i class="fas fa-microchip"></i> Motor de Simetr√≠a (SSD/Landmark)</h3>
                  <p class="text-sm text-gray-400">Utilizamos el modelo **SSD (Single Shot Detector)** para el reconocimiento del rostro y el modelo **Landmark 68** para el mapeo de los 68 puntos clave, asegurando una triangulaci√≥n precisa.</p>
              </div>
              <div class="tech-card">
                  <h3><i class="fas fa-brain"></i> An√°lisis de Proporci√≥n Bi-M√©trica (IPB)</h3>
                  <p class="text-sm text-gray-400">Algoritmo propietario que calcula la desviaci√≥n de los ejes faciales respecto a la **Proporci√≥n √Åurea (1:1.618)** y las proporciones can√≥nicas (tercios faciales) para la puntuaci√≥n est√©tica.</p>
              </div>
              <div class="tech-card">
                  <h3><i class="fas fa-database"></i> Core de Procesamiento As√≠ncrono</h3>
                  <p class="text-sm text-gray-400">Implementaci√≥n as√≠ncrona de los modelos de Detecci√≥n, Edad/G√©nero y Expresi√≥n para garantizar la **fluidez en tiempo real** (sub-20ms) durante la fase de Live Scan.</p>
              </div>
              <div class="tech-card">
                  <h3><i class="fas fa-code"></i> Arquitectura Front-End Responsiva</h3>
                  <p class="text-sm text-gray-400">Dise√±o basado en **CSS Grid y Flexbox** con arquitectura **SPA (Single Page Application)**. Optimizaci√≥n de rendering para **Webcam/Canvas** y transici√≥n de datos por *Tweening*.</p>
              </div>
          </div>
      </div>
  </div>
  
  <div id="settings-view" class="view">
      <div class="generic-view-content">
          <h1>SETTINGS: CONFIGURACI√ìN DE PAR√ÅMETROS DEL MOTOR</h1>
          <p class="text-lg text-white mb-5">Controles de Calibraci√≥n del Sistema y Gesti√≥n de Modelos IA. (Acceso restringido).</p>
          <div class="tech-card" style="border-color: var(--accent-warning);">
              <h3 style="color:var(--accent-warning);"><i class="fas fa-slider-h"></i> CONTROL DE TOLERANCIA ISF/IPB</h3>
              <p class="text-sm text-gray-400">Ajuste la sensibilidad del algoritmo de Simetr√≠a para la calificaci√≥n final (solo por Administrador de Calibraci√≥n).</p>
              <input type="range" min="1" max="3" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-3" disabled>
              <div class="flex justify-between text-xs mt-2 text-white font-mono">
                  <span>Modo Normal (75% ISF)</span>
                  <span>Modo Estricto (80% ISF)</span>
                  <span style="color:var(--ia-light); font-weight:bold;">Modo Ultra Preciso (85% ISF)</span>
              </div>
              <p class="text-xs mt-3 text-red-400">Bloqueado a Ultra Preciso para la versi√≥n PRO V13.1.</p>
          </div>
          <div class="tech-card">
              <h3><i class="fas fa-network-wired"></i> Gesti√≥n de Endpoints de Modelo</h3>
              <p class="text-sm text-gray-400">Rutas de carga y versiones de los modelos de IA (ssdMobilenetv1, faceLandmark68Net, ageGenderNet, faceExpressionNet).</p>
              <code style="display: block; background: #000; padding: 5px; margin-top: 5px; font-size: 12px; color: var(--ia);">Ruta Local: ./models/</code>
          </div>
      </div>
  </div>
  
  <div id="account-view" class="view">
      <div class="generic-view-content">
          <h1>ACCOUNT: MISI√ìN Y PERFIL CORPORATIVO</h1>
          <p class="text-lg text-white mb-5">SYMMETRY AI ENGINE PRO V13.1 es una herramienta de software biom√©trico avanzada, dise√±ada para el an√°lisis profesional y est√©tico de la morfolog√≠a facial humana.</p>
          <div class="tech-card">
              <h3><i class="fas fa-bullseye"></i> Misi√≥n del Sistema</h3>
              <p class="text-sm text-gray-400">Proporcionar una m√©trica de precisi√≥n y objetividad inigualable en la evaluaci√≥n de la simetr√≠a y la proporci√≥n facial, basada en el cruce de datos biom√©tricos y el canon est√©tico. **No es una herramienta de diagn√≥stico, sino de an√°lisis de datos.**</p>
          </div>
          <div class="tech-card">
              <h3><i class="fas fa-user-shield"></i> Seguridad y Privacidad</h3>
              <p class="text-sm text-gray-400">Todos los modelos de IA se ejecutan en el cliente (navegador/dispositivo) mediante WebAssembly. Los datos de la malla facial no se transmiten a ning√∫n servidor externo, asegurando la m√°xima privacidad y **procesamiento local (Edge Computing)**.</p>
          </div>
      </div>
  </div>

  <div id="critical-warning" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; padding:20px; background:var(--accent-error); color:#000; font-weight:900; border-radius:10px; text-align:center; box-shadow:0 0 30px var(--accent-error); width:90%; max-width:400px; font-size:1.2em; font-family:Orbitron, sans-serif; display:none;"></div>
</div>

<script src="./face-api.min.js"></script>
<script>
/*
=======================================================
JAVASCRIPT/FACE-API.JS L√ìGICA (V13.1 - REFINAMIENTO CORE)
=======================================================
* Mantiene la l√≥gica robusta de la V13.0, incluyendo la correcci√≥n de espejo.
* A√±ade la l√≥gica SPA para la navegaci√≥n.
*/
const MODELS_URL='./models';
// Elementos DOM (Live Scan)
const video=document.getElementById('webcam-feed');
const canvas=document.getElementById('capture-canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
const placeholder=document.getElementById('placeholder');
const placeholderMsg=document.getElementById('placeholder-msg');
const scanningStatus=document.getElementById('scanning-status');
const positionFeedback=document.getElementById('position-feedback');
const criticalWarningEl = document.getElementById('critical-warning');
// HUD Elements
const isfScoreEl=document.getElementById('isf-score');
const isfFeedbackEl=document.getElementById('isf-feedback');
const devLeftEl=document.getElementById('dev-left');
const devRightEl=document.getElementById('dev-right');
const beautyScoreEl=document.getElementById('beauty-score');
const ageScoreEl=document.getElementById('age-score');
const civilStatusEl=document.getElementById('civil-status');
const nationalityEl=document.getElementById('nationality');
const exprDominantEl=document.getElementById('expr-dominant');
const exprAllEl=document.getElementById('expr-all');
// Controls & Progress
const mainActionButton=document.getElementById('main-action-btn');
const progressBarContainer=document.getElementById('progress-bar-container');
const progressBar=document.getElementById('progress-bar');
const progressMessage=document.getElementById('progress-message');

let running=false,raf=null,captured=null, lastDet = null;
const ISF_THRESHOLD = 80; 

// TRADUCCIONES Y DATOS DE SIMULACI√ìN
const EXPR_TRADS = {
    'neutral': 'Serenidad', 'happy': 'Alegr√≠a/Satisfacci√≥n', 'sad': 'Melancol√≠a/Distr√©s',
    'angry': 'Tensi√≥n/Ira', 'fearful': 'Temor/Ansiedad', 'disgusted': 'Disgusto', 'surprised': 'Concentraci√≥n/Alerta'
};
const NATIONALITIES = ['Europeo (√Årea Schengen)', 'Norteamericano (NAFTA)', 'Latino (Regi√≥n Andina)', 'Latino (Regi√≥n Cono Sur)', 'Asi√°tico (Regi√≥n Oriental)'];
const CIVIL_STATUS = ['Soltero/a', 'Relaci√≥n Estable (Correlaci√≥n)', 'V√≠nculo Matrimonial (Correlaci√≥n)'];
const PROGRESS_PHRASES = ["Compiling 100+ Biometric Data Points...", "Cross-referencing Golden Ratio Axioms...", "Generating Predictive Analysis Report (DFA)...", "Finalizing Report Structure and Metadata..."];
const ANIMAL_CLASSES = ['Perro (Canino)', 'Gato (Felino)', 'Objeto Inorg√°nico', 'No-Rostro Humano'];

// === NAVEGACI√ìN SPA ===
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        const viewId = item.getAttribute('data-view');
        // Ocultar/Mostrar vistas y actualizar estado de navegaci√≥n
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
        item.classList.add('active');
        
        // L√≥gica de gesti√≥n de c√°mara al cambiar de vista
        if (viewId !== 'live-scan-view' && running) {
            stopWebcam();
        }
        if (viewId === 'live-scan-view' && !running && video.srcObject) {
            video.play();
            running = true;
            raf = requestAnimationFrame(loop);
            mainActionButton.textContent = 'üì∏ CAPTURAR DATOS';
            scanningStatus.style.display = 'block';
        }
    });
});

function stopWebcam() {
    running = false;
    cancelAnimationFrame(raf);
    video.pause();
    const stream = video.srcObject;
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}
// === FIN NAVEGACI√ìN SPA ===

// UTILIDADES
function showCriticalWarning(message) {
    criticalWarningEl.innerHTML = `üö® **${message}**`;
    criticalWarningEl.style.display = 'block';
    setTimeout(() => { criticalWarningEl.style.display = 'none'; }, 4000);
}
function checkAnimalDetection(detections) {
    // Simulaci√≥n de detecci√≥n no-humana
    if (detections.length > 0) return null; 
    if (Math.random() < 0.05) { 
        return ANIMAL_CLASSES[Math.floor(Math.random() * ANIMAL_CLASSES.length)];
    }
    return null; 
}

// Carga de modelos
async function loadModels(){
  mainActionButton.textContent = 'Cargando M√≥dulos IA...';
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
    faceapi.nets.faceExpressionNet.loadFromUri(MODELS_URL),
    faceapi.nets.ageGenderNet.loadFromUri(MODELS_URL) 
  ]);
  mainActionButton.textContent = '‚ñ∂ INICIAR ESCANEO';
  mainActionButton.disabled=false;
}
window.addEventListener('load',loadModels);

// Start camera 
mainActionButton.onclick=async()=>{
    if(mainActionButton.textContent.includes('INICIAR ESCANEO')){
        try{
            placeholderMsg.textContent = 'Solicitando acceso al WebCam Feed...';
            const stream=await navigator.mediaDevices.getUserMedia({video:true});
            video.srcObject=stream; await video.play();
            placeholder.style.display='none';
            resizeCanvas(); running=true; loop();
            mainActionButton.textContent = 'üì∏ CAPTURAR DATOS';
            mainActionButton.classList.remove('primary');
            mainActionButton.disabled = true;
            scanningStatus.style.display = 'block';
            positionFeedback.style.display = 'block';
            resetHUDLive();
        }catch(e){
            placeholderMsg.textContent = 'ERROR C√ÅMARA: No se pudo acceder. Revise los permisos.';
            showCriticalWarning('ERROR CR√çTICO: No se pudo iniciar el WebCam Feed. Revise la conexi√≥n/permisos.');
        }
    } else if (mainActionButton.textContent.includes('CAPTURAR DATOS')) {
        captureData();
    } else if (mainActionButton.textContent.includes('DESCARGAR REPORTE')) {
        downloadReport();
    } else if (mainActionButton.textContent.includes('REANUDAR')) {
        retryScan();
    }
};

// Resize canvas
function resizeCanvas(){
  const displaySize = { width: video.clientWidth, height: video.clientHeight };
  faceapi.matchDimensions(canvas, displaySize);
}
window.addEventListener('resize',resizeCanvas);
video.addEventListener('play', resizeCanvas);


// Live detection loop (FIX DEL ESPEJO Y LA MALLA)
async function loop(){
  if(!running)return;
  const displaySize = { width: canvas.width, height: canvas.height };
  
  const det=await faceapi.detectSingleFace(video,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
    .withFaceLandmarks().withFaceExpressions();
  
  const resized = det ? faceapi.resizeResults(det, displaySize) : [];
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // 1. Aplicar la transformaci√≥n de espejo al contexto
  ctx.save();
  ctx.scale(-1, 1);
  ctx.translate(-canvas.width, 0); 
  
  // 2. Dibujar el video reflejado
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // 3. Dibujar la malla facial sobre el video reflejado
  if(det) {
    faceapi.draw.drawFaceLandmarks(canvas,resized, { drawLines: true, drawPoints: true, lineWidth: 1.5, color: 'rgba(0,255,255,0.7)' });
  }

  // 4. Restaurar el contexto 
  ctx.restore();

  // >>> L√ìGICA DE BLOQUEO Y FEEDBACK <<<
  const animalDetected = checkAnimalDetection(det); 

  if (animalDetected) {
      mainActionButton.disabled = true;
      mainActionButton.classList.remove('primary');
      lastDet = null;
      showCriticalWarning(`DETECCI√ìN DE OBJETO NO-FACIAL: ${animalDetected}. An√°lisis restringido a Biometr√≠a Humana.`);
      positionFeedback.style.opacity = 0;
      resetHUDLive();

  } else if(det){
      criticalWarningEl.style.display = 'none';
      lastDet = det;
      const score=calcSymmetry(lastDet);
      
      updateLiveMetrics(score, lastDet.expressions);
      
      if (score > ISF_THRESHOLD) {
          positionFeedback.textContent = 'Rostro detectado y calibrado üü¢ (Posici√≥n Biom√©trica √ìptima)';
          positionFeedback.style.color = 'var(--accent-success)';
          mainActionButton.disabled = false;
          mainActionButton.classList.add('primary');
      } else {
          positionFeedback.textContent = 'Ajuste el eje de la cabeza y mantenga la distancia recomendada...';
          positionFeedback.style.color = 'var(--accent-warning)';
          mainActionButton.disabled = true;
          mainActionButton.classList.remove('primary');
      }
      positionFeedback.style.opacity = 1;

  } else {
    criticalWarningEl.style.display = 'none';
    lastDet = null;
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    resetHUDLive();
    
    positionFeedback.textContent = 'Buscando rostro humano... Iniciando m√≥dulo de Detecci√≥n.';
    positionFeedback.style.color = 'var(--ia)';
    positionFeedback.style.opacity = 1;
  }

  raf=requestAnimationFrame(loop);
}

// Live Metrics Update
function updateLiveMetrics(score, expressions) {
    animateScore(isfScoreEl, score.toFixed(2));
    isfFeedbackEl.textContent = updateScoreFeedback(score, false);
    
    const deviation = Math.abs(50 - (score / 100) * 50); 
    devLeftEl.style.width = `${50 + deviation}%`;
    devRightEl.style.width = `${50 - deviation}%`;
    devLeftEl.style.backgroundColor = score > 85 ? 'var(--accent-success)' : 'var(--accent-warning)';

    animateScore(beautyScoreEl, calcBeautyScore(score).toFixed(2) + '/10', 10);
    drawAureaDonut(calcBeautyScore(score) * 10);
    
    updateEmotionDisplay(expressions, false);
}

// Capture Data
function captureData(){
    if(!lastDet) return;
    
    stopWebcam();
    scanningStatus.style.display = 'none';
    positionFeedback.style.opacity = 0;
    
    // Captura de Imagen (con la transformaci√≥n de espejo para la foto final)
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    const tempCtx = tempCanvas.getContext('2d');
    
    tempCtx.save();
    tempCtx.scale(-1, 1); 
    tempCtx.translate(-tempCanvas.width, 0);
    tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
    tempCtx.restore();

    const rawCaptured = tempCanvas.toDataURL('image/png'); 
    
    // Dibujar la imagen congelada en el canvas de visualizaci√≥n
    const img=new Image(); 
    img.src=rawCaptured; 
    img.onload = () => { 
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        // Redibujar malla final sobre la imagen congelada
        const resizedForDisplay = faceapi.resizeResults(lastDet, { width: canvas.width, height: canvas.height });
        
        ctx.save();
        ctx.scale(-1, 1);
        ctx.translate(-canvas.width, 0);
        faceapi.draw.drawFaceLandmarks(canvas, resizedForDisplay, { drawLines: true, drawPoints: true, lineWidth: 1.5, color: 'rgba(0,255,255,0.7)' });
        ctx.restore();
    };

    captured = rawCaptured;
    startAnalysisFlow(lastDet);
}

// Flujo de An√°lisis con Barra de Progreso
async function startAnalysisFlow(det) {
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    mainActionButton.textContent = '‚öôÔ∏è PROCESANDO DATOS...';

    progressBarContainer.style.display = 'block';
    let currentProgress = 0;
    let step = 0;

    const progressInterval = setInterval(() => {
        if (currentProgress < 95) {
            currentProgress += Math.random() * 4 + 1; 
            currentProgress = Math.min(currentProgress, 95);
            progressBar.style.width = `${currentProgress}%`;
            
            if (currentProgress > 10 && step === 0) { progressMessage.textContent = PROGRESS_PHRASES[0]; step++; } 
            else if (currentProgress > 35 && step === 1) { progressMessage.textContent = PROGRESS_PHRASES[1]; step++; } 
            else if (currentProgress > 60 && step === 2) { progressMessage.textContent = PROGRESS_PHRASES[2]; step++; }
            else if (currentProgress > 85 && step === 3) { progressMessage.textContent = PROGRESS_PHRASES[3]; step++; }
        }
    }, 500);
    
    // Simular Carga y Ejecutar Detecciones Adicionales (Age/Gender)
    await simulateAnalysisDelay(4000); 
    
    const img=new Image(); 
    img.src=captured; await new Promise(r=>img.onload=r);
    // Ejecutar todos los modelos en la imagen est√°tica capturada
    const finalDet=await faceapi.detectSingleFace(img,new faceapi.SsdMobilenetv1Options({minConfidence:.5}))
        .withFaceLandmarks().withFaceExpressions().withAgeAndGender();
    
    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    progressMessage.textContent = 'AN√ÅLISIS COMPLETADO. Generando Reporte Final (V13.1)...';
    
    setTimeout(() => {
        progressBarContainer.style.display = 'none';
        transitionToDataAnalytics(finalDet);
    }, 1000);
}

// Transici√≥n a Data Analytics (Final Report)
function transitionToDataAnalytics(finalDet) {
    if(!finalDet){
        showCriticalWarning('ERROR DE AN√ÅLISIS: No se detect√≥ un rostro claro en la imagen est√°tica capturada.');
        mainActionButton.textContent = 'üîÑ REANUDAR LIVE SCAN';
        mainActionButton.classList.add('primary');
        mainActionButton.disabled = false;
        return;
    }

    const symmetryScore=calcSymmetry(finalDet);
    const beautyScoreNumber=calcBeautyScore(symmetryScore);
    const simulatedNationality = simulateNationality(beautyScoreNumber);
    const simulatedCivilStatus = simulateCivilStatus(finalDet.expressions);

    // DIBUJO FINAL EN CANVAS (Marcas de Detecci√≥n)
    const img=new Image(); img.src=captured; 
    img.onload = () => { 
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const resizedForDisplay = faceapi.resizeResults(finalDet,{width:canvas.width,height:canvas.height});
        
        ctx.save();
        ctx.scale(-1, 1);
        ctx.translate(-canvas.width, 0);

        faceapi.draw.drawDetections(canvas,resizedForDisplay, {boxColor: 'var(--accent-success)', lineWidth: 3});
        faceapi.draw.drawFaceLandmarks(canvas,resizedForDisplay);
        faceapi.draw.drawFaceExpressions(canvas,resizedForDisplay, 0.05);

        ctx.restore();
    };

    // Actualizar Panel de M√©tricas
    isfScoreEl.textContent = symmetryScore.toFixed(2);
    isfFeedbackEl.textContent = updateScoreFeedback(symmetryScore, true);
    beautyScoreEl.textContent = beautyScoreNumber.toFixed(2) + '/10';
    
    const genderText = finalDet.gender === 'male' ? 'HOMBRE (Masc.)' : 'MUJER (Fem.)';
    ageScoreEl.textContent = `${Math.round(finalDet.age)} a√±os (${genderText})`;
    civilStatusEl.textContent = simulatedCivilStatus;
    nationalityEl.textContent = simulatedNationality;
    updateEmotionDisplay(finalDet.expressions, true);
    
    // Finalizar controles
    mainActionButton.textContent = '‚¨áÔ∏è DESCARGAR REPORTE PROFESIONAL';
    mainActionButton.classList.add('primary');
    mainActionButton.disabled = false;
    
    showCriticalWarning('AN√ÅLISIS COMPLETO. Reporte listo para exportaci√≥n.');
}

// Retry (Reanudar Webcam)
function retryScan(){
    video.play();
    running = true;
    mainActionButton.textContent = 'üì∏ CAPTURAR DATOS';
    mainActionButton.disabled = true;
    mainActionButton.classList.remove('primary');
    scanningStatus.style.display = 'block';
    positionFeedback.style.opacity = 1;
    resetHUDLive(true);
    raf=requestAnimationFrame(loop);
}

// Download capture (Simulado)
function downloadReport(){
    if(!captured)return;
    const a=document.createElement('a');
    
    const finalImage = canvas.toDataURL('image/png'); 
    a.href=finalImage;
    a.download='SYMMETRY_ANALYSIS_V13.1_REPORTE_PROFESIONAL.png';
    a.click();
}

/*
=======================================================
L√ìGICA DE C√ÅLCULO Y SIMULACI√ìN (Refinada)
=======================================================
*/
function centroid(p){return p.reduce((a,b)=>({x:a.x+b.x,y:a.y+b.y}),{x:0,y:0});}
function dist(a,b){const dx=a.x-b.x,dy=a.y-b.y;return Math.hypot(dx,dy);}

function calcSymmetry(det){
  try{
    const lm=det.landmarks;
    const left=centroid(lm.getLeftEye()),right=centroid(lm.getRightEye()),nose=centroid(lm.getNose()),mouth=centroid(lm.getMouth());
    
    // Simetr√≠a Ocular/Nasal
    const dL=dist(left,nose),dR=dist(right,nose);
    const balance=1-Math.abs(dL-dR)/Math.max(dL,dR);
    
    // Centrado de Boca (Eje Vertical)
    const mouthSym=1-Math.abs(mouth.x-nose.x)/(canvas.width*0.05);
    
    // Proporci√≥n Ocular (A√±adiendo factor de IPB en el c√°lculo de base)
    const phi=1.618;
    const eyeDistance = dist(left,right)||1;
    const ratio=(dL+dR)/eyeDistance; // Relaci√≥n de tri√°ngulo ojo-nariz
    const phiScore=1-Math.abs(ratio-ratio/phi)/(ratio/phi);
    
    // Peso de la M√©trica: Balance (40%), Boca (30%), Proporci√≥n (30%)
    const score=Math.max(0,Math.min(100,(balance*0.40+mouthSym*0.30+phiScore*0.30)*100));
    return score;
  }catch(e){return 0;}
}

function calcBeautyScore(isf){return (isf/100) * 10;} 
function simulateNationality(beautyScore){
    const index = Math.floor(Math.random() * NATIONALITIES.length);
    let nationality = NATIONALITIES[index];
    if (beautyScore > 9.0) {
        nationality = 'Perfil ' + NATIONALITIES[Math.floor(Math.random() * 2)];
    }
    return nationality + ' (' + (Math.random() * 10 + 85).toFixed(1) + '% Confianza)';
}
function simulateCivilStatus(expressions){
    const dominant = Object.entries(expressions).sort((a,b)=>b[1]-a[1])[0][0];
    let status = CIVIL_STATUS[0]; 
    if (dominant === 'happy' || dominant === 'neutral') {
        const rand = Math.random();
        if (rand < 0.4) status = CIVIL_STATUS[1]; 
        else if (rand < 0.7) status = CIVIL_STATUS[2];
    }
    return status;
}

function updateScoreFeedback(score, finalReport){
    let feedback = '';
    if(score > 90){feedback = finalReport ? 'Nivel A++: SIMETR√çA EXCEPCIONAL. M√°ximo rendimiento bi-m√©trico.' : '√ìPTIMO: Eje de simetr√≠a perfecto detectado.';} 
    else if(score > 80){feedback = finalReport ? 'Nivel A+: ALTA SIMETR√çA. Estructura facial bien balanceada.' : 'SUPERIOR: Mantenga el encuadre para m√°xima precisi√≥n.';} 
    else if(score > 70){feedback = finalReport ? 'Nivel B: SIMETR√çA ADECUADA. Balance dentro del promedio profesional.' : 'EST√ÅNDAR: Ajuste el eje para alcanzar la zona A+.';} 
    else {feedback = finalReport ? 'Nivel C: DESVIACI√ìN DE EJE. Recomendaci√≥n de re-escaneo en posici√≥n √≥ptima.' : 'BAJO: Rostro no calibrado. Mueva la cabeza.';}
    return feedback;
}

function updateEmotionDisplay(expressions, fullReport = false){
  const sorted=Object.entries(expressions).sort((a,b)=>b[1]-a[1]);
  const dominantName = EXPR_TRADS[sorted[0][0]];
  const dominantPercent = (sorted[0][1]*100).toFixed(1);
  exprDominantEl.textContent = `${dominantName}`;
  
  if(fullReport){
      exprAllEl.innerHTML = `Espectro: ${sorted.map(e=>e[1]*100>5?`<b>${(e[1]*100).toFixed(0)}% ${EXPR_TRADS[e[0]]}</b>`:'').filter(Boolean).join(' | ')}`;
  } else {
      exprAllEl.innerHTML = `An√°lisis de la expresi√≥n facial en tiempo real...`;
  }
}
function resetHUDLive(isRetry = false){
  isfScoreEl.textContent = '‚Äî';
  isfFeedbackEl.textContent = isRetry ? 'Reanudando detecci√≥n y calibraci√≥n en tiempo real...' : 'Esperando entrada biom√©trica de alto rendimiento.';
  devLeftEl.style.width = '50%';
  devRightEl.style.width = '50%';
  beautyScoreEl.textContent = '‚Äî';
  drawAureaDonut(0);
  ageScoreEl.textContent = '‚Äî';
  civilStatusEl.textContent = '‚Äî';
  nationalityEl.textContent = '‚Äî';
  exprDominantEl.textContent = '‚Äî';
  exprAllEl.innerHTML = 'Detalle de emociones disponible tras An√°lisis Profesional...';
}

// Animaci√≥n de Puntuaci√≥n (Mantenida)
function animateScore(element, targetValue, maxValue = 100) {
    const currentValue = parseFloat(element.textContent.replace(/[^\d.]/g, '')) || 0;
    const targetNumber = parseFloat(targetValue.replace(/[^\d.]/g, '')) || 0;
    
    let startTime;
    const duration = 200; 

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const percentage = Math.min(progress / duration, 1);
        const value = currentValue + (targetNumber - currentValue) * percentage;

        if (element.id === 'beauty-score') {
            element.textContent = `${value.toFixed(1)}/10`;
        } else {
            element.textContent = value.toFixed(2);
        }

        if (percentage < 1) {
            raf = requestAnimationFrame(step);
        } else {
            element.textContent = targetValue;
        }
    }
    requestAnimationFrame(step);
}

// Dibujar Gr√°fico de Dona (IPB)
function drawAureaDonut(score) {
    const canvasEl = document.getElementById('aurea-donut');
    if (!canvasEl) return;
    const ctx = canvasEl.getContext('2d');
    const center = 50;
    const radius = 40;
    const lineWidth = 8;
    const endAngle = Math.PI * 2 * (score / 100) - Math.PI / 2;

    ctx.clearRect(0, 0, 100, 100);

    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.lineWidth = lineWidth;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(center, center, radius, -Math.PI / 2, endAngle);
    ctx.strokeStyle = score > 70 ? 'var(--ia)' : 'var(--accent-warning)';
    ctx.lineWidth = lineWidth;
    ctx.stroke();
}


async function simulateAnalysisDelay(ms){
    await new Promise(r => setTimeout(r, ms));
}
</script>
</body>
</html>
